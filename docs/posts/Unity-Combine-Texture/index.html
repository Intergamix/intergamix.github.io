<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content_Type" content="text/html; charset=UTF-8"><meta http-equiv="Cache-Control" content="max-age=7200"><meta http-equiv="Content-Encoding" content="gzip"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Unity 多纹理融合(翻译三)" /><meta name="author" content="Jasper Flick" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="本篇摘要： 采样多个纹理 应用细节纹理 处理线性空间中的颜色 使用 splat 地图" /><meta property="og:description" content="本篇摘要： 采样多个纹理 应用细节纹理 处理线性空间中的颜色 使用 splat 地图" /><link rel="canonical" href="https://www.damonc.top/posts/Unity-Combine-Texture/" /><meta property="og:url" content="https://www.damonc.top/posts/Unity-Combine-Texture/" /><meta property="og:site_name" content="afeng" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-01-02T20:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Unity 多纹理融合(翻译三)" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@catlikecoding" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jasper Flick","url":"https://catlikecoding.com/jasper-flick/"},"dateModified":"2022-10-23T22:00:00+08:00","datePublished":"2018-01-02T20:00:00+08:00","description":"本篇摘要： 采样多个纹理 应用细节纹理 处理线性空间中的颜色 使用 splat 地图","headline":"Unity 多纹理融合(翻译三)","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.damonc.top/posts/Unity-Combine-Texture/"},"url":"https://www.damonc.top/posts/Unity-Combine-Texture/"}</script><title> Unity 多纹理融合(翻译三) - afeng</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="mask-icon" href="/assets/img/favicons/safari-pinned-tab.svg" color="#5bbad5"><meta name="apple-mobile-web-app-title" content="afeng`s blog"><meta name="application-name" content="Afeng Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><link rel="stylesheet" href="/assets/css/APlayer.min.css"> <script src="/assets/js/dist/APlayer.min.js"></script> <script src="/assets/js/dist/Meting.min.js"></script> <script async src="/assets/js/dist/Valine.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://damonc-top2.github.io/web-assets/commons/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-subtitle"><p>思绪来去无影踪</p><p>偶尔会在这里停留</p></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href=" javascript:location.href = 'mailto:' + ['damonc','126.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href=" /feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Unity 多纹理融合(翻译三)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Unity 多纹理融合(翻译三)</h1><div class="post-meta text-muted"><div class="d-flex"><div> <span> 作者 <em> <a href="https://catlikecoding.com/jasper-flick/">Jasper Flick</a> </em> </span> <span> 发表于 <em class="timeago" data-ts="1514894400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-01-02 </em> </span> <span> 更新于 <em class="timeago" data-ts="1666533600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-10-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6565 字"> <em>36 分钟</em>阅读</span></div></div></div><div class="post-content"><p>本篇摘要：</p><ul><li>采样多个纹理<li>应用细节纹理<li>处理线性空间中的颜色<li>使用 splat 地图</ul><h2 id="纹理合并"><span class="mr-2">纹理合并</span><a href="#纹理合并" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /> <center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/tutorial-image.jpg" width="500" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>融合多张纹理.</b></i></center> </font><p>贴图在游戏应用广泛，但它们有局限性。无论以何种尺寸显示，它们都有固定数量的像素。如果需要被渲染到很小网格，可以使用mipmap来保持它们的部分细节。但是当渲染到很大的网格上，会变得模糊。我们也不能无中生有地渲染更多额外的细节。本文讨论了一些解决办法。</p><h3 id="细节纹理"><span class="mr-2">细节纹理</span><a href="#细节纹理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>通常可以使用更大的纹理，意味着更多的像素和更多的细节。但是纹理的大小也是有限制的，取决于游戏包体大小和目标平台的内存，以及gpu采样能力。</p><p>另一种增加像素密度的方法是平铺纹理。出一张尽可能小的贴图，设置为重复模式。近距离观察下重复感可能不会很明显。毕竟当你站着用鼻子接触墙壁时，你只会看到整面墙壁的一小部分。</p><p>因此，我们能够通过拉伸与平铺纹理相结合的方式来尽可能地添加细节。为了尝试这一点，我们使用一张棱角明显的纹理。这是一个方格图，放入的工程内使用默认导入设置。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/grid.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>略微扭曲的网格纹理.</b></i></center> </font><p>新建一个纹理融合shader</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Custom/Textured With Detail"</span> <span class="p">{</span>
    <span class="n">Properties</span> <span class="p">{</span>
        <span class="n">_Tint</span> <span class="p">(</span><span class="s">"Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">SubShader</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用此着色器创建一个新材质，然后为其指定该shader和网格纹理。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/detailed-inspector.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/detailed-scene.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>网格纹理.</b></i></center> </font><p>将材质分配给quad并查看它。从远处看效果还行。但是靠得太近看会变得模糊不清。缺失一些细节，同时纹理压缩造成的伪影也会变得很明显。 网格特写，显示低纹素密度和 DXT1 伪影。 多个纹理样本</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/grid-close-up.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>带有低像素密度和DXT1伪影.</b></i></center> </font><h3 id="多张纹理贴图采样"><span class="mr-2">多张纹理贴图采样</span><a href="#多张纹理贴图采样" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>现在我们只采样了单个纹理样本并将其用作片段着色器的结果，将采样的颜色存储在一个临时变量中。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="n">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>先假设可以通过引入平铺纹理的方式来增加像素密度。执行一次纹理采样函数，给它一个十倍采样面积，用这个结果替换临时存储的颜色原来的颜色输出到屏幕。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</pre></table></code></div></div><p>屏幕上会产生很多小网格。靠的很近再观察，结果不那么糟糕了。因为采样纹理用了平铺10次，所以很明显是一个重复的图案。 硬编码平铺。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/tiling.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>平铺纹理.</b></i></center> </font><p>请注意，此时我们正在执行两个纹理采样，但最终却只使用其中一个。这似乎很浪费。是吗？看看编译的顶点程序。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">uniform</span>  <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec2</span> <span class="n">vs_TEXCOORD0</span><span class="p">;</span>
<span class="n">layout</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">out</span> <span class="n">vec4</span> <span class="n">SV_TARGET0</span><span class="p">;</span>
<span class="n">vec2</span> <span class="n">t0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">t0</span><span class="p">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">vs_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">vec2</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">);</span>
    <span class="n">SV_TARGET0</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">t0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">SetTexture</span> <span class="mi">0</span> <span class="p">[</span><span class="n">_MainTex</span><span class="p">]</span> <span class="mi">2</span><span class="n">D</span> <span class="mi">0</span>
      <span class="n">ps_4_0</span>
      <span class="n">dcl_sampler</span> <span class="n">s0</span><span class="p">,</span> <span class="n">mode_default</span>
      <span class="n">dcl_resource_texture2d</span> <span class="p">(</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">)</span> <span class="n">t0</span>
      <span class="n">dcl_input_ps</span> <span class="n">linear</span> <span class="n">v0</span><span class="p">.</span><span class="n">xy</span>
      <span class="n">dcl_output</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span>
      <span class="n">dcl_temps</span> <span class="mi">1</span>
   <span class="mi">0</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r0</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">l</span><span class="p">(</span><span class="mf">10.000000</span><span class="p">,</span> <span class="mf">10.000000</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">)</span>
   <span class="mi">1</span><span class="o">:</span> <span class="n">sample</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">t0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">s0</span>
   <span class="mi">2</span><span class="o">:</span> <span class="n">ret</span>
</pre></table></code></div></div><p>是否注意到编译后的代码中只有一个纹理采样？没错，编译器为我们去掉了不必要的代码！编译器基本上会丢弃任何最终未使用的内容。</p><p>我们不想丢弃原始采样到颜色，就要合并两次采样结果。让我们通过将它们相乘来做到这一点。再添加一个_Tint属性，叠加一层自定义颜色。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
<span class="n">color</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</pre></table></code></div></div><p>着色编译器会生成什么样的代码呢，对此有何影响？</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">uniform</span>  <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec2</span> <span class="n">vs_TEXCOORD0</span><span class="p">;</span>
<span class="n">layout</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">out</span> <span class="n">vec4</span> <span class="n">SV_TARGET0</span><span class="p">;</span>
<span class="n">mediump</span> <span class="n">vec4</span> <span class="n">t16_0</span><span class="p">;</span>
<span class="n">lowp</span> <span class="n">vec4</span> <span class="n">t10_0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">t10_0</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">vs_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="n">t16_0</span> <span class="o">=</span> <span class="n">t10_0</span> <span class="o">*</span> <span class="n">t10_0</span><span class="p">;</span>
    <span class="n">SV_TARGET0</span> <span class="o">=</span> <span class="n">t16_0</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">SetTexture</span> <span class="mi">0</span> <span class="p">[</span><span class="n">_MainTex</span><span class="p">]</span> <span class="mi">2</span><span class="n">D</span> <span class="mi">0</span>
<span class="n">ConstBuffer</span> <span class="s">"$Globals"</span> <span class="mi">144</span>
<span class="n">Vector</span> <span class="mi">96</span> <span class="p">[</span><span class="n">_Tint</span><span class="p">]</span>
<span class="n">BindCB</span>  <span class="s">"$Globals"</span> <span class="mi">0</span>
      <span class="n">ps_4_0</span>
      <span class="n">dcl_constantbuffer</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">immediateIndexed</span>
      <span class="n">dcl_sampler</span> <span class="n">s0</span><span class="p">,</span> <span class="n">mode_default</span>
      <span class="n">dcl_resource_texture2d</span> <span class="p">(</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">)</span> <span class="n">t0</span>
      <span class="n">dcl_input_ps</span> <span class="n">linear</span> <span class="n">v0</span><span class="p">.</span><span class="n">xy</span>
      <span class="n">dcl_output</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span>
      <span class="n">dcl_temps</span> <span class="mi">1</span>
   <span class="mi">0</span><span class="o">:</span> <span class="n">sample</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">t0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">s0</span>
   <span class="mi">1</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">2</span><span class="o">:</span> <span class="n">mul</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">xyzw</span>
   <span class="mi">3</span><span class="o">:</span> <span class="n">ret</span>
</pre></table></code></div></div><p>这次的纹理采样，编译器检测到重复对_MainTex采样代码。对其进行优化后纹理只采样一次，结果存储在寄存器中并重复使用。即使使用_Tint中间变量等，编译器也足够聪明，可以检测到此类代码重复。最终将所有结果汇总后输出。</p><p>现在再对UV坐标平铺×10次，最终看到大网格和小网格的融合在一起</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">color</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/multiplied.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>平铺纹理.</b></i></center> </font><p>由于纹理采样时参数不再相同，编译器也必须保留两次采样。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">uniform</span>  <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec2</span> <span class="n">vs_TEXCOORD0</span><span class="p">;</span>
<span class="n">layout</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">out</span> <span class="n">vec4</span> <span class="n">SV_TARGET0</span><span class="p">;</span>
<span class="n">vec4</span> <span class="n">t0</span><span class="p">;</span>
<span class="n">lowp</span> <span class="n">vec4</span> <span class="n">t10_0</span><span class="p">;</span>
<span class="n">vec2</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">lowp</span> <span class="n">vec4</span> <span class="n">t10_1</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">t10_0</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">vs_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">t10_0</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">vs_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">vec2</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">);</span>
    <span class="n">t10_1</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="n">SV_TARGET0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">*</span> <span class="n">t10_1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">SetTexture</span> <span class="mi">0</span> <span class="p">[</span><span class="n">_MainTex</span><span class="p">]</span> <span class="mi">2</span><span class="n">D</span> <span class="mi">0</span>
<span class="n">ConstBuffer</span> <span class="s">"$Globals"</span> <span class="mi">144</span>
<span class="n">Vector</span> <span class="mi">96</span> <span class="p">[</span><span class="n">_Tint</span><span class="p">]</span>
<span class="n">BindCB</span>  <span class="s">"$Globals"</span> <span class="mi">0</span>
      <span class="n">ps_4_0</span>
      <span class="n">dcl_constantbuffer</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">immediateIndexed</span>
      <span class="n">dcl_sampler</span> <span class="n">s0</span><span class="p">,</span> <span class="n">mode_default</span>
      <span class="n">dcl_resource_texture2d</span> <span class="p">(</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">)</span> <span class="n">t0</span>
      <span class="n">dcl_input_ps</span> <span class="n">linear</span> <span class="n">v0</span><span class="p">.</span><span class="n">xy</span>
      <span class="n">dcl_output</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span>
      <span class="n">dcl_temps</span> <span class="mi">2</span>
   <span class="mi">0</span><span class="o">:</span> <span class="n">sample</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">t0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">s0</span>
   <span class="mi">1</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">xyzw</span>
   <span class="mi">2</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r1</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">l</span><span class="p">(</span><span class="mf">10.000000</span><span class="p">,</span> <span class="mf">10.000000</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">)</span>
   <span class="mi">3</span><span class="o">:</span> <span class="n">sample</span> <span class="n">r1</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r1</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">t0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">s0</span>
   <span class="mi">4</span><span class="o">:</span> <span class="n">mul</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r1</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">5</span><span class="o">:</span> <span class="n">ret</span>
</pre></table></code></div></div><h3 id="单独的细节纹理"><span class="mr-2">单独的细节纹理</span><a href="#单独的细节纹理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>将两个纹理相乘时，结果会更暗。除非至少其中一种纹理是白色的。这是因为像素的每个颜色通道都有一个介于 0 和 1 之间的值。当向纹理添加细节时，可以通过该通道值来实现变暗或变亮。</p><p>要使原始纹理变亮，给原始颜色乘2，使得每个颜色值都增大。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">color</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/doubled.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>增亮颜色.</b></i></center> </font><p>这种直接扩大倍数的做法很粗暴。我们知道任何数乘以1不变，但是对细节纹理色加倍时，但对于1/2这个分界值就有用了。颜色区间是0-1，低于1/2的值将是结果变暗，高于1/2的值将变亮。这里引入一张特殊的灰度细节纹理来处理。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/grid-detail.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>细节灰度图.</b></i></center> </font><blockquote class="prompt-tip"><div><p>灰度细节纹理？</p><p>一般都是用灰度细节纹理来增白或加深原始颜色做二次细节调整，不是灰度图跳出 的颜色不是那么直观的结果。</p></div></blockquote><p>要使用这个单独的细节纹理，我们必须在着色器中添加第二个纹理属性。使用灰色作为默认值，因为这不会改变主纹理的外观。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_Tint</span> <span class="p">(</span><span class="s">"Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_DetailTex</span> <span class="p">(</span><span class="s">"Detail Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"gray"</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>将细节纹理分配给我们的材质并将其平铺设置为10。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/detail-texture-inspector.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>两种纹理.</b></i></center> </font><p>我们必须添加变量来访问细节纹理及其平铺和偏移数据</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">,</span> <span class="n">_DetailTex_ST</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="使用两个uv"><span class="mr-2">使用两个UV</span><a href="#使用两个uv" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>我们应该使用细节纹理的平铺和偏移数据，而不是使用硬编码乘10。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
  <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
  <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
  <span class="n">float2</span> <span class="n">uvDetail</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>通过使用主纹理uv对细节纹理进行采样，得到一个新的细节纹理uv。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">Interpolators</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">i</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
  <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
  <span class="n">i</span><span class="p">.</span><span class="n">uvDetail</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_DetailTex</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>再一次看看汇编代码</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">uniform</span> 	<span class="n">vec4</span> <span class="n">_Tint</span><span class="p">;</span>
<span class="n">uniform</span> 	<span class="n">vec4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
<span class="n">uniform</span> 	<span class="n">vec4</span> <span class="n">_DetailTex_ST</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec4</span> <span class="n">in_POSITION0</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec2</span> <span class="n">in_TEXCOORD0</span><span class="p">;</span>
<span class="n">out</span> <span class="n">vec2</span> <span class="n">vs_TEXCOORD0</span><span class="p">;</span>
<span class="n">out</span> <span class="n">vec2</span> <span class="n">vs_TEXCOORD1</span><span class="p">;</span>
<span class="n">vec4</span> <span class="n">t0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">in_POSITION0</span><span class="p">.</span><span class="n">yyyy</span> <span class="o">*</span> <span class="n">glstate_matrix_mvp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">glstate_matrix_mvp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">in_POSITION0</span><span class="p">.</span><span class="n">xxxx</span> <span class="o">+</span> <span class="n">t0</span><span class="p">;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">glstate_matrix_mvp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">in_POSITION0</span><span class="p">.</span><span class="n">zzzz</span> <span class="o">+</span> <span class="n">t0</span><span class="p">;</span>
    <span class="n">gl_Position</span> <span class="o">=</span> <span class="n">glstate_matrix_mvp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">in_POSITION0</span><span class="p">.</span><span class="n">wwww</span> <span class="o">+</span> <span class="n">t0</span><span class="p">;</span>
    <span class="n">vs_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">in_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="o">+</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">zw</span><span class="p">;</span>
    <span class="n">vs_TEXCOORD1</span><span class="p">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">in_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span> <span class="o">*</span> <span class="n">_DetailTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="o">+</span> <span class="n">_DetailTex_ST</span><span class="p">.</span><span class="n">zw</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">Vector</span> <span class="mi">112</span> <span class="p">[</span><span class="n">_MainTex_ST</span><span class="p">]</span>
<span class="n">Vector</span> <span class="mi">128</span> <span class="p">[</span><span class="n">_DetailTex_ST</span><span class="p">]</span>
<span class="n">ConstBuffer</span> <span class="s">"UnityPerDraw"</span> <span class="mi">352</span>
<span class="n">Matrix</span> <span class="mi">0</span> <span class="p">[</span><span class="n">glstate_matrix_mvp</span><span class="p">]</span>
<span class="n">BindCB</span>  <span class="s">"$Globals"</span> <span class="mi">0</span>
<span class="n">BindCB</span>  <span class="s">"UnityPerDraw"</span> <span class="mi">1</span>
      <span class="n">vs_4_0</span>
      <span class="n">dcl_constantbuffer</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">immediateIndexed</span>
      <span class="n">dcl_constantbuffer</span> <span class="n">cb1</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">immediateIndexed</span>
      <span class="n">dcl_input</span> <span class="n">v0</span><span class="p">.</span><span class="n">xyzw</span>
      <span class="n">dcl_input</span> <span class="n">v1</span><span class="p">.</span><span class="n">xy</span>
      <span class="n">dcl_output_siv</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">position</span>
      <span class="n">dcl_output</span> <span class="n">o1</span><span class="p">.</span><span class="n">xy</span>
      <span class="n">dcl_output</span> <span class="n">o1</span><span class="p">.</span><span class="n">zw</span>
      <span class="n">dcl_temps</span> <span class="mi">1</span>
   <span class="mi">0</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">yyyy</span><span class="p">,</span> <span class="n">cb1</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">xyzw</span>
   <span class="mi">1</span><span class="o">:</span> <span class="n">mad</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">cb1</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">xxxx</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">2</span><span class="o">:</span> <span class="n">mad</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">cb1</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">zzzz</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">3</span><span class="o">:</span> <span class="n">mad</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">cb1</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">wwww</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">4</span><span class="o">:</span> <span class="n">mad</span> <span class="n">o1</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">zwzz</span>
   <span class="mi">5</span><span class="o">:</span> <span class="n">mad</span> <span class="n">o1</span><span class="p">.</span><span class="n">zw</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">xxxy</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">xxxy</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">zzzw</span>
   <span class="mi">6</span><span class="o">:</span> <span class="n">ret</span>
</pre></table></code></div></div><p>注意两个 UV 输出是如何在两个编译器顶点程序中定义的。OpenGLCore使用vs_TEXCOORD0和vs_TEXCOORD1输出，相反Direct3D11只使用一个输出o1.</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// Output signature:</span>
<span class="c1">//</span>
<span class="c1">// Name                 Index   Mask Register SysValue  Format   Used</span>
<span class="c1">// -------------------- ----- ------ -------- -------- ------- ------</span>
<span class="c1">// SV_POSITION              0   xyzw        0      POS   float   xyzw</span>
<span class="c1">// TEXCOORD                 0   xy          1     NONE   float   xy  </span>
<span class="c1">// TEXCOORD                 1     zw        1     NONE   float     zw</span>
</pre></table></code></div></div><p>上面代码意味着两个 UV 对都被打包到一个输出寄存器中。第一个在 X 和 Y 通道，第二个在 Z 和 W 通道。因为寄存器总是由四个数字组成的组。Direct3D 11 编译器利用了这一点。</p><blockquote class="prompt-tip"><div><p>试着手动打包输出? 手动打包输出的常见原因是只有少数几个插值器可用。Shader Model 2硬件支持8个通用插补 器，而Shader Model 3硬件支持10个。复杂着色器可能会遇到这个限制。</p></div></blockquote><p>现在我们可以在片段程序中使用额外的UV对。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="n">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
	<span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
	<span class="n">color</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_DetailTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uvDetail</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">uniform</span> 	<span class="n">vec4</span> <span class="n">_Tint</span><span class="p">;</span>
<span class="n">uniform</span> 	<span class="n">vec4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
<span class="n">uniform</span> 	<span class="n">vec4</span> <span class="n">_DetailTex_ST</span><span class="p">;</span>
<span class="n">uniform</span>  <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
<span class="n">uniform</span>  <span class="n">sampler2D</span> <span class="n">_DetailTex</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec2</span> <span class="n">vs_TEXCOORD0</span><span class="p">;</span>
<span class="n">in</span>  <span class="n">vec2</span> <span class="n">vs_TEXCOORD1</span><span class="p">;</span>
<span class="n">layout</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">out</span> <span class="n">vec4</span> <span class="n">SV_TARGET0</span><span class="p">;</span>
<span class="n">vec4</span> <span class="n">t0</span><span class="p">;</span>
<span class="n">lowp</span> <span class="n">vec4</span> <span class="n">t10_0</span><span class="p">;</span>
<span class="n">lowp</span> <span class="n">vec4</span> <span class="n">t10_1</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">t10_0</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">vs_TEXCOORD0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">t10_0</span> <span class="o">*</span> <span class="n">_Tint</span><span class="p">;</span>
    <span class="n">t10_1</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">_DetailTex</span><span class="p">,</span> <span class="n">vs_TEXCOORD1</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">*</span> <span class="n">t10_1</span><span class="p">;</span>
    <span class="n">SV_TARGET0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">t0</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">SetTexture</span> <span class="mi">0</span> <span class="p">[</span><span class="n">_MainTex</span><span class="p">]</span> <span class="mi">2</span><span class="n">D</span> <span class="mi">0</span>
<span class="n">SetTexture</span> <span class="mi">1</span> <span class="p">[</span><span class="n">_DetailTex</span><span class="p">]</span> <span class="mi">2</span><span class="n">D</span> <span class="mi">1</span>
<span class="n">ConstBuffer</span> <span class="s">"$Globals"</span> <span class="mi">144</span>
<span class="n">Vector</span> <span class="mi">96</span> <span class="p">[</span><span class="n">_Tint</span><span class="p">]</span>
<span class="n">BindCB</span>  <span class="s">"$Globals"</span> <span class="mi">0</span>
      <span class="n">ps_4_0</span>
      <span class="n">dcl_constantbuffer</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">immediateIndexed</span>
      <span class="n">dcl_sampler</span> <span class="n">s0</span><span class="p">,</span> <span class="n">mode_default</span>
      <span class="n">dcl_sampler</span> <span class="n">s1</span><span class="p">,</span> <span class="n">mode_default</span>
      <span class="n">dcl_resource_texture2d</span> <span class="p">(</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">)</span> <span class="n">t0</span>
      <span class="n">dcl_resource_texture2d</span> <span class="p">(</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">,</span><span class="kt">float</span><span class="p">)</span> <span class="n">t1</span>
      <span class="n">dcl_input_ps</span> <span class="n">linear</span> <span class="n">v0</span><span class="p">.</span><span class="n">xy</span>
      <span class="n">dcl_input_ps</span> <span class="n">linear</span> <span class="n">v0</span><span class="p">.</span><span class="n">zw</span>
      <span class="n">dcl_output</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span>
      <span class="n">dcl_temps</span> <span class="mi">2</span>
   <span class="mi">0</span><span class="o">:</span> <span class="n">sample</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">xyxx</span><span class="p">,</span> <span class="n">t0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">s0</span>
   <span class="mi">1</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">cb0</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">xyzw</span>
   <span class="mi">2</span><span class="o">:</span> <span class="n">sample</span> <span class="n">r1</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">v0</span><span class="p">.</span><span class="n">zwzz</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">s1</span>
   <span class="mi">3</span><span class="o">:</span> <span class="n">mul</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r1</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">4</span><span class="o">:</span> <span class="n">add</span> <span class="n">o0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span><span class="p">,</span> <span class="n">r0</span><span class="p">.</span><span class="n">xyzw</span>
   <span class="mi">5</span><span class="o">:</span> <span class="n">ret</span>
</pre></table></code></div></div><p>基于细节纹理，主纹理变得更亮和更暗。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/grid-with-detail.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore><body> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/grid-close-up-detail.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>明暗两张纹理.</b></i></center> </font><h3 id="细节纹理渐变融合"><span class="mr-2">细节纹理渐变融合</span><a href="#细节纹理渐变融合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>添加细节的想法是它们可以在近距离或放大时改善材质的外观。它们不应该在远处可见或缩小，因为这会使平铺变得明显。所以我们需要一种方法来随着纹理显示尺寸的减小而淡化细节。我们可以通过将细节纹理淡化为灰色来做到这一点，因为这不会导致颜色变化。</p><p>需要做的就是在细节纹理的导入设置中启用Fadeout Mip Maps属性。这也会自动将过滤器模式切换为三线性，以便渐变为灰色是渐进的。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/fading-inspector.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore><body> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/grid-fading-detail.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>纹理过渡.</b></i></center> </font><p>网格从详细到不详细的过渡非常明显，但通常不会注意到它。例如，这里是大理石材质的主纹理和细节纹理。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/marble.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore><body> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/marble-detail.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>大理石纹理.</b></i></center> </font><p>一旦我们的材质使用了这些纹理，细节纹理的过渡痕迹就不再明显了。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/marble-inspector.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore><body> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/marble-scene.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>大理石材质.</b></i></center> </font><p>然而，由于细节纹理的过渡加持，大理石材质在近距离看起来要好得多。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/marble-close.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore><body> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/marble-close-detail.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>没有细节和有细节特写.</b></i></center> </font><h3 id="线性色彩空间"><span class="mr-2">线性色彩空间</span><a href="#线性色彩空间" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>当我们在 gamma 颜色空间中渲染场景时，我们的着色器工作正常，但如果我们切换到线性颜色空间，它就会出错。色彩空间在项目中设置。它配置在Other Settings播放器设置面板，可以通过Edit / Project Settings / Player.</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/color-space-inspector.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>选择颜色空间.</b></i></center> </font><h3 id="什么是gamma色彩空间"><span class="mr-2">什么是gamma色彩空间?</span><a href="#什么是gamma色彩空间" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>伽玛空间是指经过伽玛校正的色彩空间。伽玛校正是对光强度的调整。最简单的方法是将原始值提高到某个幂次，即$value^gamma$。 gamma为 1 表示没有变化， 随着gamma递增光强度递增。</p><p>这种转换最初是为了适应 CRT 显示器的非线性特性而引入的。另一个好处是它也大致对应于我们的眼睛对不同光强度的敏感程度。我们注意到深色之间的差异比明亮颜色之间的差异更大。因此，将更多的数字位分配给较暗的值而不是较浅的值是有意义的。求幂运算允许将较低的值扩展到更大的范围，同时压缩较高的值。</p><p>最广泛使用的图像颜色格式是sRGB。它使用比简单求幂更复杂的公式，sRGB以$1\over 2.2$的平均gamma值存储颜色，正常情况下这是一个合理的近似值。要将此数据转换回其原始颜色，请2.2幂的伽马校正。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/liner-gama.png" width="400" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>gamma$1\over 2.2$encoding vs. $2.2$deconding.</b></i></center> </font><p>假设Unity纹理的颜色存储为sRGB。在伽马空间中渲染时，着色器直接访问原始颜色和纹理数据。这是我们到目前为止所假设的。</p><p>但是在线性空间中渲染时，就不再适用。 GPU会将采样的纹理颜色转换为线性空间。此外，Unity 也会将材质颜色属性转换为线性空间。然后着色器使用这些线性颜色进行操作。之后，片段程序的输出将被转换回伽马空间。</p><p>使用线性颜色的优点之一是它可以实现更逼真的照明计算。这是因为光的相互作用在现实生活中是线性的，而不是指数的。不幸的是,切换到线性空间后，细节材料变得更暗。为什么会这样？</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/gamma-space.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore><body> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/linear-space.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>gama vs. linear 色彩空间.</b></i></center> </font><p>因为我们将细节纹理采样后的颜色乘了2，所以$1\over 2$的值不会导致主纹理发生任何变化。但是，转换为线性空间后，它会变为接近${1\over 2} ^{2.2} \approx 0.22$。加倍大约是0.44，远小于 1。这就解释了为什么变得更暗。</p><p>我们可以通过在细节纹理的导入设置中启用<em>Bypass sRGB Sampling</em>来解决这个错误。这可以防止从伽玛到线性空间的转换，因此着色器将始终访问原始图像数据。但是，细节纹理是sRGB图像，所以结果仍然是错误的。</p><p>最好的解决方案是重新对齐细节颜色，使它们再次以 1 为中心。我们可以通过${1 \over {1\over 2} ^{2.2}} \approx 4.59$而不是乘以2来做到这一点。但我们只能在线性空间中渲染时才这样计算。</p><p><em>UnityCG.cginc</em>定义了一个统一变量，它将包含要与之相乘的正确数字。它是一个 <code class="language-plaintext highlighter-rouge">float4</code>，它的 rgb 分量有2或约4.59，这两个值视情况而定。由于伽马校正未应用于Alpha通道，因此始终为2。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">color</span> <span class="o">*=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_DetailTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uvDetail</span><span class="p">)</span> <span class="o">*</span> <span class="n">unity_ColorSpaceDouble</span><span class="p">;</span>
</pre></table></code></div></div><p>通过这种更改，无论我们在哪个颜色空间中渲染，我们的细节材质看起来都一样。</p><h2 id="纹理splat过渡遮罩"><span class="mr-2">纹理splat过渡遮罩</span><a href="#纹理splat过渡遮罩" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>细节纹理的一个限制是对整个表面使用相同的细节。 这适用于均匀的表面，如大理石板。但是，如果材质没有统一的外观，不希望在任何地方都使用相同的细节。</p><p>考虑一个大地形。它可以有草、沙、岩石、雪等。希望这些地形类型有一定的细节。但是覆盖整个地形的纹理永远不会有足够的细节。可以通过为每种表面类型使用单独的纹理并平铺这些纹理来解决该问题。但是怎么知道在哪里使用哪种纹理呢？</p><p>假设我们有一个具有两种不同表面类型的地形，什么时候决定使用哪种表面纹理呢。不是一就是二。我们可以用一个布尔值来表示这个逻辑。如果设置为true，我们使用第一个纹理，否则使用第二个。我们可以使用灰度纹理来存储这个选择。值1表示第一个纹理，而值0表示第二个纹理。事实上，我们可以使用这些值在两个纹理之间进行线性插值。然后介于 0 和 1 之间的值表示两种纹理之间的混合，这使得平滑过渡成为可能。</p><p>这样的纹理被称为splat贴图。就像将多个地形特征喷溅到画布上一样。由于插值，这张地图甚至不需要高分辨率。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/binary-splat-map.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>splat遮罩贴图.</b></i></center> </font><p>将其添加到项目后，将其导入类型切换为高级。启用Bypass sRGB Sampling并指示其mipmap应在Linear Space中生成。因为该纹理不需要sRGB颜色。所以在线性空间中渲染时不应该进行转换。另外，将其 Wrap Mode 设置为clamp，因为我们不会平铺这张地图。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/splat-map-binary-import.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>splat导入设置.</b></i></center> </font><p>创建一个新的 Texture Splatting 着色器。</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Custom/Texture Splatting"</span> <span class="p">{</span>
    <span class="n">Properties</span> <span class="p">{</span>
        <span class="n">MainTex</span> <span class="p">(</span><span class="s">"Splat Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">SubShader</span> <span class="p">{</span>
        <span class="n">Pass</span> <span class="p">{</span>
        <span class="n">CGPROGRAM</span>

        <span class="cp">#pragma vertex MyVertexProgram
</span>        <span class="cp">#pragma fragment MyFragmentProgram
</span>
        <span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
</span>
        <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>

        <span class="k">struct</span> <span class="nc">VertexData</span> <span class="p">{</span>
            <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
            <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
            <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
            <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Interpolators</span> <span class="n">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">i</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
            <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">float4</span> <span class="n">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>创建一个新材质并引用该shader，并将splat贴图指定为其主要纹理。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/splat-map-binary-scene.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>splat图渲染.</b></i></center> </font><h3 id="增加融合纹理"><span class="mr-2">增加融合纹理</span><a href="#增加融合纹理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>为了能够在两个纹理之间进行选择，作为属性添加命名为Texture1和Texture2到我们的着色器中。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Splat Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_Texture1</span> <span class="p">(</span><span class="s">"Texture 1"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_Texture2</span> <span class="p">(</span><span class="s">"Texture 2"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>可以为他们使用任何你想要的纹理,这里使用网格纹理和大理石纹理。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/two-textures-inspector.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>增加的额外纹理.</b></i></center> </font><p>为添加到着色器的每个纹理修改平铺和偏移控制值。这需要我们将更多数据从顶点传递到片段着色器，或者在片元着色器中计算UV调整。 这很好，但通常地形的所有纹理都平铺相同。并且 splat 地图根本没有平铺。所以我们只需要一个平铺和偏移控件的实例。</p><p>可以将属性控制添加到着色器属性之前，就像在C#代码中一样。<code class="language-plaintext highlighter-rouge">NoScaleOffset</code>将禁用纹理平铺和偏移。</p><div file="shader" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="shader"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Splat Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_Texture1</span> <span class="p">(</span><span class="s">"Texture 1"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_Texture2</span> <span class="p">(</span><span class="s">"Texture 2"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>同时修改splat贴图tiling为4。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/no-tiling-offset.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>不需要额外的贴图纹理.</b></i></center> </font><p>将采样器变量添加到我们的着色器代码中，但是不必添加它们对应的 _ST 变量。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>

<span class="n">sampler2D</span> <span class="n">_Texture1</span><span class="p">,</span> <span class="n">_Texture2</span><span class="p">;</span>
</pre></table></code></div></div><p>对两张纹理采样后叠加，颜色会得到加深，然后输出</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="nf">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture1</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture2</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="err">}</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/textures-added.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>纹理叠加.</b></i></center> </font><h3 id="使用splat贴图"><span class="mr-2">使用splat贴图</span><a href="#使用splat贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>采样splat纹理需要顶点程序提供的UV坐标</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">Interpolators</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uvSplat</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Interpolators</span> <span class="nf">MyVertexProgram</span> <span class="p">(</span><span class="n">VertexData</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Interpolators</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
    <span class="n">i</span><span class="p">.</span><span class="n">uvSplat</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然后，以在对其他纹理进行采样之前对splat贴图进行采样。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">float4</span> <span class="nf">MyFragmentProgram</span> <span class="p">(</span><span class="n">Interpolators</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">splat</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uvSplat</span><span class="p">);</span>
    <span class="k">return</span>
    <span class="nf">tex2D</span><span class="p">(</span><span class="n">_Texture1</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture2</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="err">}</span>
</pre></table></code></div></div><p>因为splat本身是单通道，可以任选一个RGB通道来来存储值，这里先决定使用第一个纹理与splat贴图R通道相乘。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_Texture1</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">splat</span><span class="p">.</span><span class="n">r</span> <span class="o">+</span>
       <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture2</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/modulating-first-texture.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>调制第一个纹理.</b></i></center> </font><p>第一个纹理现在由splat贴图R通道调制。为了完成插值，我们必须将另一个纹理<code class="language-plaintext highlighter-rouge">1-R</code>相乘。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_Texture1</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">splat</span><span class="p">.</span><span class="n">r</span> <span class="o">+</span>
       <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture2</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">splat</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/modulating-both-textures.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>调制两个纹理.</b></i></center> </font><h3 id="rgb-splat贴图"><span class="mr-2">RGB Splat贴图</span><a href="#rgb-splat贴图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>我们有一个功能性的splat材质，但它只支持两种纹理。我们可以支持更多吗？我们现在只使用了R通道，那么我们添加G和B通道怎么样？那么(1,0,0)代表第一个纹理，(0,1,0)代表第二个纹理，(0,0,1)代表第三个纹理。 为了在这三个之间获得正确的插值，我们只需要确保RGB通道的总和为1即可。</p><p>但是等等，当我们只使用一个通道时，我们可以支持两个纹理。这是因为第二个纹理的权重是通过<code class="language-plaintext highlighter-rouge">1-R</code>得出的。同样的技巧适用于任意数量的通道。因此可以通过<code class="language-plaintext highlighter-rouge">1-R-G-B</code>支持另一种纹理。</p><p>这导致了一个具有三种颜色和黑色的splat贴图。只要三个通道加起来不超过1，它就是一个有效的贴图。这里给出一张这样的贴图，导入Unity。</p><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 250 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/rgb-splat-map.png" width="250" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>RGB splat 贴图.</b></i></center> </font><blockquote class="prompt-warning"><div><p>当 R + G + B 超过1时会发生什么？</p><p>那么前三个纹理的组合会太强。 同时，第四个纹理将被减去而不是被添加。 如果错误很小，那么不会注 意到并且结果足够好。 示例 RGB 映射实际上并不完美，但不会注意到。 纹理压缩引入了更多错误，但 同样难以察觉。</p></div></blockquote><blockquote class="prompt-tip"><div><p>可以使用alpha通道吗？</p><p>确实可以！ 这意味着单个 RGBA splat 贴图最多可以支持五种不同的地形类型。 但是对于本教程，四个 就足够了。</p><p>如果要使用超过五个纹理，则必须使用多个splat贴图。虽然这是可能的，但最终会得到很多纹理采样 此时可以使用更好的技术，例如纹理数组。</p></div></blockquote><p>为了支持 RGB splat贴图，我们必须在着色器中添加两个额外的纹理。为它们分配了大理石细节和测试纹理。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Splat Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_Texture1</span> <span class="p">(</span><span class="s">"Texture 1"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_Texture2</span> <span class="p">(</span><span class="s">"Texture 2"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_Texture3</span> <span class="p">(</span><span class="s">"Texture 3"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span> <span class="n">_Texture4</span> <span class="p">(</span><span class="s">"Texture 4"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/splat-map-rgb-inspector.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>Four textures.</b></i></center> </font><p>将所需的变量添加到着色器。 再一次，没有额外的 _ST需要的变量。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">sampler2D</span> <span class="n">_Texture1</span><span class="p">,</span> <span class="n">_Texture2</span><span class="p">,</span> <span class="n">_Texture3</span><span class="p">,</span> <span class="n">_Texture4</span><span class="p">;</span>
</pre></table></code></div></div><p>在片段程序中，添加额外的纹理样本。第二个样本现在使用G通道，第三个使用B通道。最终样本用 (1 - R - G - B) 调制。</p><div file="cg" class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="cg"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">retur1n</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_Texture1</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">splat</span><span class="p">.</span><span class="n">r</span> <span class="o">+</span>
        <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture2</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">splat</span><span class="p">.</span><span class="n">g</span> <span class="o">+</span>
        <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture3</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">splat</span><span class="p">.</span><span class="n">b</span> <span class="o">+</span>
        <span class="n">tex2D</span><span class="p">(</span><span class="n">_Texture4</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">splat</span><span class="p">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">splat</span><span class="p">.</span><span class="n">g</span> <span class="o">-</span> <span class="n">splat</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>
</pre></table></code></div></div><center class="half"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 111'%3E%3C/svg%3E" class="fit-picture" data-src="https://damonc-top2.github.io/web-assets/posts/2018/month1/catRender3/four-textures-splatted.png" width="300" height="111" alt="loading failed, need vpn." data-proofer-ignore></center> <font size="2.5"> <center><i><b>四个纹理飞溅.</b></i></center> </font><blockquote class="prompt-tip"><div><p>为什么混合区域在线性色彩空间中看起来不同？</p><p>我们的 splat 贴图绕过了 sRGB 采样，所以混合不应该取决于我们使用的颜色空间，对吧？ splat 地图 确实不受影响。 但是发生混合的色彩空间确实发生了变化。</p><p>在伽马空间渲染的情况下，样本在伽马空间中混合，仅此而已。 但是在线性空间中渲染时，它们首先转换为 线性空间，然后混合，然后再转换回伽马空间。 结果略有不同。 在线性空间中，混合也是线性的。 但在伽 马空间中，混合偏向较深的颜色。</p></div></blockquote><p>现在知道如何应用细节纹理以及如何将多个纹理与splat贴图混合。也可以组合这些方法。</p><p>可以将四个细节纹理添加到splat着色器并使用贴图在它们之间进行混合。当然，这需要四个额外的纹理采样，性能有限。</p><p>还可以使用贴图来控制应用细节纹理的位置以及省略的位置。在这种情况下，需要一张单色贴图，它可以用作遮罩。当单个纹理同时包含表示多个不同材质的区域但没有地形那么大的面积时，这很有用。例如，如果我们的大理石纹理还包含金属片，则不希望在此处应用大理石细节。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E7%BF%BB%E8%AF%91/'>翻译</a>, <a href='/categories/shader/'>Shader</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/unity3d/" class="post-tag no-text-decoration" >Unity3D</a> <a href="/tags/shader/" class="post-tag no-text-decoration" >Shader</a> <a href="/tags/texture/" class="post-tag no-text-decoration" >Texture</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unity+%E5%A4%9A%E7%BA%B9%E7%90%86%E8%9E%8D%E5%90%88%28%E7%BF%BB%E8%AF%91%E4%B8%89%29+-+afeng&url=https%3A%2F%2Fwww.damonc.top%2Fposts%2FUnity-Combine-Texture%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unity+%E5%A4%9A%E7%BA%B9%E7%90%86%E8%9E%8D%E5%90%88%28%E7%BF%BB%E8%AF%91%E4%B8%89%29+-+afeng&u=https%3A%2F%2Fwww.damonc.top%2Fposts%2FUnity-Combine-Texture%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.damonc.top%2Fposts%2FUnity-Combine-Texture%2F&text=Unity+%E5%A4%9A%E7%BA%B9%E7%90%86%E8%9E%8D%E5%90%88%28%E7%BF%BB%E8%AF%91%E4%B8%89%29+-+afeng" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Unity+%E5%A4%9A%E7%BA%B9%E7%90%86%E8%9E%8D%E5%90%88%28%E7%BF%BB%E8%AF%91%E4%B8%89%29+-+afeng&url=https%3A%2F%2Fwww.damonc.top%2Fposts%2FUnity-Combine-Texture%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Unity-Multi-Light/">Unity基础光照多光源采样(翻译五)</a><li><a href="/posts/Unity-First-light/">Unity基础光照(翻译四)</a><li><a href="/posts/Unity-Shader-Fundamentals/">Unity Shader Fundamentals(翻译二)</a><li><a href="/posts/Unity-Combine-Texture/">Unity 多纹理融合(翻译三)</a><li><a href="/posts/Unity-Matrix&Transform/">Unity Transform&Matrix(翻译一)</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/shader/">Shader</a> <a class="post-tag" href="/tags/unity3d/">Unity3D</a> <a class="post-tag" href="/tags/light/">Light</a> <a class="post-tag" href="/tags/texture/">Texture</a> <a class="post-tag" href="/tags/cg/">CG</a> <a class="post-tag" href="/tags/markdown/">Markdown</a></div></div></div><center> <span> <font size="0.5px" color="#dd0000">音乐会被广告插件拦截</font> </span> </center> <meting-js server='netease' type='song' id='1949917422' autoplay="true" list-max-height="340px" width="100%" preload="auto" volume="0.3" order="random" mini="false" mutex="true" list-folded="true"> </meting-js> <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 mb-5"><div class="panel-heading pl-1 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Unity-Advance-Texture/"><div class="card-body"> <em class="timeago small" data-ts="1515067200" > 2018-01-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unity纹理高级用法(翻译六)</h3><div class="text-muted small"><p> 本篇摘要: 扰动法线以模拟凹凸视觉 从高度场计算法线 采样和混合法线贴图 从切线空间转换到世界空间 Bump Map(凹凸贴图): Bump Map Type Describe NormalMap 法线图，映射公式：normal=pixel*2-1,反映射：pixel=...</p></div></div></a></div><div class="card"> <a href="/posts/Unity-Matrix&Transform/"><div class="card-body"> <em class="timeago small" data-ts="1514768400" > 2018-01-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unity Transform&Matrix(翻译一)</h3><div class="text-muted small"><p> 本篇摘要信息 matrix介绍 matrix推导 模拟transform缩放 旋转 位移功能 可视空间 Unity Shader是怎么知道一个像素该画在哪个位置？下面是先展示一组Cube，一步步分析下去 cube数组. 操控一组3维坐标 创建一组10*10*10的3维Cube数组，并作为UnityMatric...</p></div></div></a></div><div class="card"> <a href="/posts/Unity-Shader-Fundamentals/"><div class="card-body"> <em class="timeago small" data-ts="1514880000" > 2018-01-02 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unity Shader Fundamentals(翻译二)</h3><div class="text-muted small"><p> 本篇摘要信息 顶点变换 Color pixels shader 属性 从顶点传数据至片元函数 查看编译后的shader代码 场景初始化 新建一个默认场景，新建一个圆球。这个默认场景本身进行了大量复杂的渲染，为了更容易的掌握Unity的渲染过程，我们先做一些简化设置，把默认的某些花里胡哨的东西先剥离掉。 剥离天空盒 打开Window-Lighting，查看光照...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Unity-Shader-Fundamentals/" class="btn btn-outline-primary" prompt="上一篇"><p>Unity Shader Fundamentals(翻译二)</p></a> <a href="/posts/Unity-First-light/" class="btn btn-outline-primary" prompt="下一篇"><p>Unity基础光照(翻译四)</p></a></div><div></div><div class="cmt"> <i class="fas fa-comments fa-fw"></i> 评论</div><div id="vcomments"></div><script type="text/javascript"> function DelayLoadGiscus() { new Valine({ el: '#vcomments' , verify: "true", notify: "false", app_id: "qdLDShfUTw1gY7ZUKqz9xdRs-gzGzoHsz", app_key: "rlEDXk0Dg2kcpk2hqVulFDaY", avatar: "monsterid", placeholder: "欢迎评论！", pageSize: "10 || 10", master: "b5586e582cb181c6b0fc8b2ce828bd50", tagMeta: ["博主","小伙伴","访客"], enableQQ: true, requiredFields: ['nick'] }); $(document).ready(function(){ fetch('https://v1.hitokoto.cn') .then(response => response.json()) .then(data => { document.getElementById("veditor").setAttribute( "placeholder", data.hitokoto+"—"+data.from ); } ) .catch(console.error) }); } setTimeout(() => { DelayLoadGiscus() }, 10000); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> <span>©2016-2022-</span> <span><a href="https://www.damonc.top">阿锋 -</a></span> <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"> 云上的日子 </span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/shader/">Shader</a> <a class="post-tag" href="/tags/unity3d/">Unity3D</a> <a class="post-tag" href="/tags/light/">Light</a> <a class="post-tag" href="/tags/texture/">Texture</a> <a class="post-tag" href="/tags/cg/">CG</a> <a class="post-tag" href="/tags/markdown/">Markdown</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>
