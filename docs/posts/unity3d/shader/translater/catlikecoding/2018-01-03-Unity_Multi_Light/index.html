<!doctypehtml><html class=no-js lang=zh><meta charset=utf-8><meta content=on http-equiv=x-dns-prefetch-control><link href=//www.damonc.top rel=dns-prefetch><link href=//search.www.damonc.top rel=dns-prefetch><link href=//api.github.com rel=dns-prefetch><link href=//www.google-analytics.com rel=dns-prefetch><meta content=width=device-width,initial-scale=1 name=viewport><meta content=在文件目录中手动创建一个MyLighting.cginc文件，再把FirstLighting.shader内从#pragma以下到ENDCG以上区间内代码拷贝进*MyLighting.cginc*文件。这样我们不直接在shader中写这些重复的代码，而是通过include引用。 name=description><meta content=catlikecoding name=author><link href=https://www.damonc.top/posts/unity3d/shader/translater/catlikecoding/2018-01-03-Unity_Multi_Light/ rel=canonical><link href=../../../../../../favicon.ico rel=icon><meta content="mkdocs-1.4.2, mkdocs-material-8.5.11"name=generator><title>Unity 基础光照多光源采样(翻译五) - 银河揽月</title><link href=../../../../../../assets/stylesheets/main.31645160.min.css rel=stylesheet><link href=../../../../../../assets/stylesheets/palette.2505c338.min.css rel=stylesheet><link href=../../../../../../extension/css/extra.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback rel=stylesheet><style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}@font-face {font-family:'Fira Sans';font-style:normal;font-weight:300;src:local('Fira Sans'),local('FiraSans-Normal'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-300.eot?#iefix) format('embedded-opentype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-300.woff2) format('woff2'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-300.woff) format('woff'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-300.ttf) format('truetype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-300.svg#FiraSans) format('svg')}@font-face {font-family:'Fira Sans';font-style:normal;font-weight:regular;src:local('Fira Sans'),local('FiraSans-Normal'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-regular.eot?#iefix) format('embedded-opentype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-regular.woff2) format('woff2'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-regular.woff) format('woff'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-regular.ttf) format('truetype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-regular.svg#FiraSans) format('svg')}@font-face {font-family:'Fira Sans';font-style:italic;font-weight:regular;src:local('Fira Sans'),local('FiraSans-Italic'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-italic.eot?#iefix) format('embedded-opentype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-italic.woff2) format('woff2'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-italic.woff) format('woff'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-italic.ttf) format('truetype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-italic.svg#FiraSans) format('svg')}@font-face {font-family:'Fira Sans';font-style:normal;font-weight:700;src:local('Fira Sans'),local('FiraSans-Normal'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-700.eot?#iefix) format('embedded-opentype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-700.woff2) format('woff2'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-700.woff) format('woff'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-700.ttf) format('truetype'),url(//lib.baomitu.com/fonts/fira-sans/fira-sans-700.svg#FiraSans) format('svg')}@font-face {font-family:'Fira Mono';font-style:normal;font-weight:regular;src:local('Fira Mono'),local('FiraMono-Normal'),url(//lib.baomitu.com/fonts/fira-mono/fira-mono-regular.eot?#iefix) format('embedded-opentype'),url(//lib.baomitu.com/fonts/fira-mono/fira-mono-regular.woff2) format('woff2'),url(//lib.baomitu.com/fonts/fira-mono/fira-mono-regular.woff) format('woff'),url(//lib.baomitu.com/fonts/fira-mono/fira-mono-regular.ttf) format('truetype'),url(//lib.baomitu.com/fonts/fira-mono/fira-mono-regular.svg#FiraMono) format('svg')}</style><script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head><body data-md-color-accent=red data-md-color-primary=white data-md-color-scheme=default dir=ltr><script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script><input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox><input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox><label class=md-overlay for=__drawer></label><div data-md-component=skip><a class=md-skip href=#include-files> 跳转至 </a></div><div data-md-component=announce></div><header class=md-header data-md-component=header><nav class="md-header__inner md-grid"aria-label=页眉><a class="md-header__button md-logo"aria-label=银河揽月 data-md-component=logo href=../../../../../.. title=银河揽月> <img alt=logo src=../../../../../../images/homepage.png> </a><label class="md-header__button md-icon"for=__drawer><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> 银河揽月 </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Unity 基础光照多光源采样(翻译五) </span></div></div></div><form class=md-header__option data-md-component=palette><input aria-label="Switch to dark mode"data-md-color-media="(prefers-color-scheme: light)"class=md-option data-md-color-accent=red data-md-color-primary=white data-md-color-scheme=default id=__palette_1 name=__palette type=radio><label class="md-header__button md-icon"title="Switch to dark mode"for=__palette_2 hidden><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg></label><input aria-label="Switch to light mode"data-md-color-media="(prefers-color-scheme: dark)"class=md-option data-md-color-accent=slate data-md-color-primary=slate data-md-color-scheme=slate id=__palette_2 name=__palette type=radio><label class="md-header__button md-icon"title="Switch to light mode"for=__palette_1 hidden><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg></label></form><label class="md-header__button md-icon"for=__search><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input aria-label=搜索 autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=搜索 required spellcheck=false><label class="md-search__icon md-icon"for=__search><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg></label><nav aria-label=查找 class=md-search__options><button class="md-search__icon md-icon"aria-label=清空当前内容 tabindex=-1 title=清空当前内容 type=reset><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg></button></nav></form><div class=md-search__output><div class=md-search__scrollwrap data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta>正在初始化搜索引擎</div><ol class=md-search-result__list></ol></div></div></div></div></div><div class=md-header__source><a class=md-source data-md-component=source href=https://github.com/damonc-top/damonc-top.github.io title=前往仓库> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512"xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg></div> <div class=md-source__repository>damonc-top</div> </a></div></nav></header><div class=md-container data-md-component=container><nav aria-label=标签 class=md-tabs data-md-component=tabs><div class="md-tabs__inner md-grid"><ul class=md-tabs__list><li class=md-tabs__item><a class=md-tabs__link href=../../../../../..> 首页 </a></li><li class=md-tabs__item><a class=md-tabs__link href=../../../../il2cpp/> Unity3D引擎 </a></li></ul></div></nav><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary"data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted"aria-label=导航栏 data-md-level=0><label class=md-nav__title for=__drawer><a class="md-nav__button md-logo"aria-label=银河揽月 data-md-component=logo href=../../../../../.. title=银河揽月> <img alt=logo src=../../../../../../images/homepage.png> </a> 银河揽月</label><div class=md-nav__source><a class=md-source data-md-component=source href=https://github.com/damonc-top/damonc-top.github.io title=前往仓库> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512"xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg></div> <div class=md-source__repository>damonc-top</div> </a></div><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle"data-md-toggle=__nav_1 id=__nav_1 type=checkbox> <label class=md-nav__link for=__nav_1>首页 <span class="md-nav__icon md-icon"></span></label> <nav aria-label=首页 class=md-nav data-md-level=1><label class=md-nav__title for=__nav_1><span class="md-nav__icon md-icon"></span> 首页</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../../../../..> 简介 </a></li><li class=md-nav__item><a class=md-nav__link href=../../../../../home/learn/> 记录 </a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle"data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label class=md-nav__link for=__nav_2>Unity3D引擎 <span class="md-nav__icon md-icon"></span></label> <nav aria-label=Unity3D引擎 class=md-nav data-md-level=1><label class=md-nav__title for=__nav_2><span class="md-nav__icon md-icon"></span> Unity3D引擎</label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle"data-md-toggle=__nav_2_1 id=__nav_2_1 type=checkbox> <label class=md-nav__link for=__nav_2_1>il2cpp <span class="md-nav__icon md-icon"></span></label> <nav aria-label=il2cpp class=md-nav data-md-level=2><label class=md-nav__title for=__nav_2_1><span class="md-nav__icon md-icon"></span> il2cpp</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../../../il2cpp/> il2cpp简介 </a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle"data-md-toggle=__nav_2_2 id=__nav_2_2 type=checkbox> <label class=md-nav__link for=__nav_2_2>Shader <span class="md-nav__icon md-icon"></span></label> <nav aria-label=Shader class=md-nav data-md-level=2><label class=md-nav__title for=__nav_2_2><span class="md-nav__icon md-icon"></span> Shader</label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-nav__toggle md-toggle"data-md-toggle=__nav_2_2_1 id=__nav_2_2_1 type=checkbox> <label class=md-nav__link for=__nav_2_2_1>翻译CatlikeCoding <span class="md-nav__icon md-icon"></span></label> <nav aria-label=翻译CatlikeCoding class=md-nav data-md-level=3><label class=md-nav__title for=__nav_2_2_1><span class="md-nav__icon md-icon"></span> 翻译CatlikeCoding</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../> Catlikecoding简介 </a></li><li class=md-nav__item><a class=md-nav__link href=../unity_matrix_transform/> 一UnityShader变换矩阵 </a></li><li class=md-nav__item><a class=md-nav__link href=../unity_shader_fundamentals/> 二UnityShader基本语法 </a></li><li class=md-nav__item><a class=md-nav__link href=../unity_combine_texture/> 三UnityShader纹理融合 </a></li><li class=md-nav__item><a class=md-nav__link href=../unity_base_light/> 四UnityShader基础光照 </a></li></ul></nav></li></ul></nav></li></ul></nav></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary"data-md-component=sidebar data-md-type=toc><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--secondary"aria-label=目录><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> 目录</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#include-files> Include Files </a></li><li class=md-nav__item><a class=md-nav__link href=#第二光源-direction> 第二光源-Direction </a> <nav aria-label=第二光源-Direction class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#增加第二个pass> 增加第二个Pass </a></li><li class=md-nav__item><a class=md-nav__link href=#合批-draw-call-batches> 合批-Draw Call Batches </a></li><li class=md-nav__item><a class=md-nav__link href=#帧调试-frame-debugger> 帧调试-Frame Debugger </a></li></ul></nav></li><li class=md-nav__item><a class=md-nav__link href=#点光源point-lights> 点光源Point Lights </a> <nav aria-label="点光源Point Lights"class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#光照函数-light-function> 光照函数-Light Function </a></li><li class=md-nav__item><a class=md-nav__link href=#光照位置-light-position> 光照位置-Light Position </a></li><li class=md-nav__item><a class=md-nav__link href=#光的衰减-light-attenuation> 光的衰减-Light Attenuation </a></li><li class=md-nav__item><a class=md-nav__link href=#光源范围-light-range> 光源范围-Light Range </a></li></ul></nav></li><li class=md-nav__item><a class=md-nav__link href=#混合光源-mixing-light> 混合光源-Mixing Light </a> <nav aria-label="混合光源-Mixing Light"class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#变体-shader-variants> 变体-Shader Variants </a></li><li class=md-nav__item><a class=md-nav__link href=#使用关键字-keywords> 使用关键字-KeyWords </a></li></ul></nav></li><li class=md-nav__item><a class=md-nav__link href=#聚光源-spotlights> 聚光源-Spotlights </a> <nav aria-label=聚光源-Spotlights class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#聚光源衰减> 聚光源衰减 </a></li></ul></nav></li><li class=md-nav__item><a class=md-nav__link href=#光斑阴影-light-cookies> 光斑阴影-Light Cookies </a> <nav aria-label="光斑阴影-Light Cookies"class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#聚光灯光斑阴影-spotlight-cookie> 聚光灯光斑阴影-Spotlight cookie </a></li><li class=md-nav__item><a class=md-nav__link href=#方向光斑阴影-directon-light-cookie> 方向光斑阴影-Directon light Cookie </a></li><li class=md-nav__item><a class=md-nav__link href=#电光源光斑阴影-point-light-cookie> 电光源光斑阴影-Point Light cookie </a></li></ul></nav></li><li class=md-nav__item><a class=md-nav__link href=#顶点光照计算-vertex-lights> 顶点光照计算-Vertex Lights </a> <nav aria-label="顶点光照计算-Vertex Lights"class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#一个顶点光-one-vertex-light> 一个顶点光-One Vertex Light </a></li><li class=md-nav__item><a class=md-nav__link href=#四个顶点光-four-vertex-light> 四个顶点光-Four Vertex Light </a></li></ul></nav></li><li class=md-nav__item><a class=md-nav__link href=#球谐函数-spherical-harmonics> 球谐函数-Spherical Harmonics </a> <nav aria-label="球谐函数-Spherical Harmonics"class=md-nav><ul class=md-nav__list><li class=md-nav__item><a class=md-nav__link href=#球谐函数频率-spherical-harmonics-bands> 球谐函数频率-Spherical Harmonics Bands </a></li><li class=md-nav__item><a class=md-nav__link href=#实际运用球谐函数-using-spherical-harmonics> 实际运用球谐函数-Using Spherical Harmonics </a></li><li class=md-nav__item><a class=md-nav__link href=#球谐采样skybox> 球谐采样Skybox </a></li></ul></nav></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><a class="md-content__button md-icon"href=https://github.com/damonc-top/damonc-top.github.io/discussions/posts/unity3d/shader/translater/catlikecoding/2018-01-03-Unity_Multi_Light.md title=编辑此页> <svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a><h1>Unity 基础光照多光源采样(翻译五)</h1><p>本篇摘要： * 使用多个光源渲染 * 支持多光源类型 * 使用光照信息 * 计算顶点光照 * 了解球谐函数</p><h2 id=include-files>Include Files<a title="Permanent link"class=headerlink href=#include-files></a></h2><p>为了给Shader增加支持多个光源，我们需要增加更多Pass通道。但是这些Pass最终包含了几乎完全相似的代码，为了避免代码的重复性，我们可以通过把着色器代码移动到一个CG文件，然后在Shader代码中引用该文件</p><p>在文件目录中手动创建一个<em>MyLighting.cginc</em>文件，再把FirstLighting.shader内从#pragma以下到ENDCG以上区间内代码拷贝进<em>MyLighting.cginc</em>文件。这样我们不直接在shader中写这些重复的代码，而是通过include引用。</p><p>注意，.cginc文件也提供了类似的避免重复定义，#define XXX_INCLUDED，再把整个文件内容放置在预处理文件块中。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#if !defined(MY_LIGHTING_INCLUDED)</span><span class=w></span>
<span class=cp>#define MY_LIGHTING_INCLUDED</span><span class=w></span>
<span class=c1>//...</span>
<span class=cp>#endif</span><span class=w></span>
</code></pre></div></td></tr></table></div><h2 id=第二光源-direction>第二光源-Direction<a title="Permanent link"class=headerlink href=#第二光源-direction></a></h2><p>新建两个方向光对象，参数设置如下图：</p><p>{% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170341532-560338425.png" url2="posts/2018/month1/catRender5/1692664-20200131170342560-220020815.png" des="两个光源参数" width="250" %}</p><p>现在场景中有两个光，但是每个物体看起来没有什么区别。现在我们一次只激活一个光源，看看有什么变化。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170343820-1237520965.png" url2="posts/2018/month1/catRender5/1692664-20200131170344924-561932944.png" des="左main光源，右minor光源" width="250" %}</p><h3 id=增加第二个pass>增加第二个Pass<a title="Permanent link"class=headerlink href=#增加第二个pass></a></h3><p>当前场景内只能看见一个光源效果，这是由于<em>MyMultiLightShader</em>只有一个Pass且只计算了一个光源。<strong>Pass光照标签ForwardBase只计算主光源， 为了渲染额外的光源，需要增加一个Pass且指定光照标签为ForwardAdd方可计算额外的光源。</strong></p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>SubShader</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Pass</span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>Tags</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"LightMode"</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>"ForwardBase"</span><span class=w> </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=n>CGPROGRAM</span><span class=w></span>
<span class=w>        </span><span class=cp>#pragma target 3.0</span><span class=w></span>
<span class=w>        </span><span class=cp>#pragma vertex MyVertexProgram</span><span class=w></span>
<span class=w>        </span><span class=cp>#pragma fragment MyFragmentProgram</span><span class=w></span>
<span class=w>        </span><span class=err>#</span><span class=n>include</span><span class=w> </span><span class=s>"MyLighting.cginc"</span><span class=w></span>
<span class=w>        </span><span class=n>ENDCG</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>Pass</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<span class=w>        </span><span class=n>Tags</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"LightMode"</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>"ForwardAdd"</span><span class=w> </span><span class=p>}</span><span class=w> </span>
<span class=w>        </span><span class=n>CGPROGRAM</span><span class=w> </span>
<span class=w>        </span><span class=cp>#pragma target 3.0 </span><span class=w></span>
<span class=w>        </span><span class=cp>#pragma vertex MyVertexProgram </span><span class=w></span>
<span class=w>        </span><span class=cp>#pragma fragment MyFragmentProgram </span><span class=w></span>
<span class=w>        </span><span class=err>#</span><span class=n>include</span><span class=w> </span><span class=s>"MyLighting.cginc"</span><span class=w> </span>
<span class=w>        </span><span class=n>ENDCG</span><span class=w> </span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>现在虽然计算了两个光源，但是ForwardAdd计算结果会直接覆盖ForwardBase的结果。我们需要把这两个光照效果结合起来，需要在ForwardAdd Pass内使用混合。</p><p><code>UnityShader的Blend函数：如何通过定义两个因子来合并新旧数据？</code> 新旧数据分别与Blend函数的因子相乘然后相加，得到最终结果。如果Pass内没有Blend默认不混合，Blend One Zero。每个Pass计算后的数据会写入帧缓冲区中，也就会替换之前任何写入该缓冲区的内容。为了把新旧数据都能加到帧缓冲区，我们可以需要指示GPU使用Blend one one模式。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>Pass</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Tags</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"LightMode"</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>"ForwardAdd"</span><span class=w> </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>Blend</span><span class=w> </span><span class=n>One</span><span class=w> </span><span class=n>One</span><span class=w></span>
<span class=w>    </span><span class=c1>//...</span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>{% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170346085-57501515.png" url2="posts/2018/month1/catRender5/1692664-20200131170347297-299894450.png" des="左无混合， 右one one混合" width="250" %}</p><blockquote><p>Z-buffer GPU`s depth buffer：</p><p>一个物体第一次被渲染，GPU就会检查该片元是否会渲染在其他已经渲染过的像素的前面，这些距离 信息就存储在该缓冲区中。因此每个像素都有颜色和深度信息**，该深度表示从相机到最近表面的 每个像素的距离。 {: .prompt-tip}</p></blockquote><p>ForwardBase中，如果要渲染的片元前面没有任何内容(深度值最小)，它就是最靠近摄像机的表面。GPU也会继续运行fragment程序，生成新的颜色和记录新的深度。如果要渲染的片元的深度值最终比已经存在的大，说明它前面有东西，它就不会被渲染也不能看见。在forward add中重复计算minor光时，要添加到已经存在的灯光，再次运行fragment程序时，因为针对的是同一个对象，最终记录了完全相同的深度值。因此两次写入相同的深度信息是没必要的，用ZWrite off关闭它。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>Blend</span><span class=w> </span><span class=n>One</span><span class=w> </span><span class=n>One</span><span class=w></span>
<span class=n>ZWrite</span><span class=w> </span><span class=n>Off</span><span class=w></span>
</code></pre></div></td></tr></table></div><h3 id=合批-draw-call-batches>合批-Draw Call Batches<a title="Permanent link"class=headerlink href=#合批-draw-call-batches></a></h3><p>在Game视图右上角打开Stats窗口，可以更好地了解运行时发生的事情。查看Batches、Saved by batching数据。先只激活main光源。</p><p>{% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170348247-405218884.png" des="Batches数据6，总共7" width="250" %}</p><p>场景内有5个对象，应该是5个Batches。见下图图 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170349609-184596067.png" des="实际Batches" width="250" %}</p><p>通过FrameDebugger分析，实际是5个draw mesh加上3个内置阴影render函数，一共8个Batches。但是由于启用了动态批处理dynamic batching，所以有一个Saved by batching统计。</p><p>那现在来消除这3个阴影渲染函数调用，打开Edit/Project Settings/Quality。Shadows选择Disable Shadows. 先无视它这个系统清屏Clear函数。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170350413-440673646.png" url1="posts/2018/month1/catRender5/1692664-20200131170351202-1645091654.png" des="去掉了阴影渲染函数" width="250" %}</p><p>激活minor光源，如下图： {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170352081-307079946.png" url1="posts/2018/month1/catRender5/1692664-20200131170352945-1221523117.png" des="<strong>10</strong> + 1 = 11" width="250" %}</p><p>10个Batches？ 因为这5个对象被渲染了两次，最终为10个批次，而不是上面的4个。 动态批处理失效了！Unity规定动态批处理最多只支持一个方向光作用的物体对象。</p><h3 id=帧调试-frame-debugger>帧调试-Frame Debugger<a title="Permanent link"class=headerlink href=#帧调试-frame-debugger></a></h3><p>通过Window/Frame Debugger打开可以清楚了解屏幕画面是如何被渲染出来的 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131170353920-34619021.png" des="Frame Debugger调试" width="250" %}</p><p>通过选择滑动条可单步调试渲染，窗口会自动显示每一步的细节。按照上面的顺序，优先画出了靠近相机的不透明物体，同时开启depth-buffer深度缓冲，这个front-to-back从前到后的渲染顺序是有效的，被遮挡的片元就会被跳过不渲染。如果使用back-to-front从后到前的顺序，同时关闭zwrite，就会覆写远处的像素，发生overdraw。</p><p>Unity渲染顺序是front-to-back，同时Unity喜欢把相似的物体分组。例如，sphere和cube分开，可避免在不同mesh网格间切换；或者把使用相同的material分组。</p><h2 id=点光源point-lights>点光源Point Lights<a title="Permanent link"class=headerlink href=#点光源point-lights></a></h2><p>先关闭两个方向光，再创建一个Point Light光。然后打开Frame Debugger调试查看。单步调试发现，第一次渲染的的纯黑色，然后才有怪异的光。</p><p><strong>什么奇怪现象？</strong> 即使没有激活方向光第一个base Pass始终都会渲染，因此渲染得到一个黑色轮廓。而第二个Pass会额外渲染一次，这次使用了point light代替了方向光，而代码任然是假设使用了方向光。</p><h3 id=光照函数-light-function>光照函数-Light Function<a title="Permanent link"class=headerlink href=#光照函数-light-function></a></h3><p>光越来越复杂了，现在把UnityLight的计算单独剥离为一个函数：</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>UnityLight</span><span class=w> </span><span class=nf>CreateLight</span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>){</span><span class=w></span>
<span class=w>    </span><span class=n>UnityLight</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>color</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_LightColor0</span><span class=p>.</span><span class=n>rgb</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w>   </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>ndotl</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>DotClamped</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>lightDir</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>修改后的Fragment代码如下：</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>float4</span><span class=w> </span><span class=nf>MyFragmentProgram</span><span class=w> </span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>SV_TARGET</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>//float3 lightDir = _WorldSpaceLightPos0.xyz;</span>
<span class=w>    </span><span class=c1>//float3 lightColor = _LightColor0.rgb;</span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>viewDir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>_WorldSpaceCameraPos</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>albedo</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>tex2D</span><span class=p>(</span><span class=n>_MainTex</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>uv</span><span class=p>).</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>_Tint</span><span class=p>.</span><span class=n>rgb</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>specularTint</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>oneMinusReflectivity</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>albedo</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>DiffuseAndSpecularFromMetallic</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>albedo</span><span class=p>,</span><span class=w> </span><span class=n>_Metallic</span><span class=p>,</span><span class=w> </span><span class=n>specularTint</span><span class=p>,</span><span class=w> </span><span class=n>oneMinusReflectivity</span><span class=w></span>
<span class=w>    </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// UnityLight light;</span>
<span class=w>    </span><span class=c1>// light.color = lightColor;</span>
<span class=w>    </span><span class=c1>// light.dir = lightDir;</span>
<span class=w>    </span><span class=c1>// light.ndotl = DotClamped(i.normal, lightDir);</span>
<span class=w>    </span><span class=n>UnityLight</span><span class=w> </span><span class=n>light</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>CreateLight</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>UnityIndirect</span><span class=w> </span><span class=n>indirectLight</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w>   </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>specular</span><span class=w>  </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nf>UNITY_BRDF_PBS</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>albedo</span><span class=p>,</span><span class=w> </span><span class=n>specularTint</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>oneMinusReflectivity</span><span class=p>,</span><span class=w> </span><span class=n>_Smoothness</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>viewDir</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>light</span><span class=p>,</span><span class=w> </span><span class=n>indirectLight</span><span class=w></span>
<span class=w>    </span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><h3 id=光照位置-light-position>光照位置-Light Position<a title="Permanent link"class=headerlink href=#光照位置-light-position></a></h3><p><code>_WorldSpaceLightPos0</code>变量包含的是当前光的位置，但是在方向光的情况下，它实际上保存的是光方向的朝向。而我们使用了Point Light，这个变量就只是光的位置了(如其名)。因此必须要我们自己计算光的方向：减去片元的世界位置再归一化得到。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>//light.dir = _WorldSpaceLightPos0.xyz;</span>
<span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w>   </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
</code></pre></div></td></tr></table></div><h3 id=光的衰减-light-attenuation>光的衰减-Light Attenuation<a title="Permanent link"class=headerlink href=#光的衰减-light-attenuation></a></h3><p>在使用方向光的情况下，只需知道光的方向即可，因为它被认为是无限远的。 但是Point Light有明确的位置，这意味它到物体表面的距离也会产生影响，距离物体越远，物体表面越暗。也就是光的衰减。方向光的衰减是被假设为非常缓慢的以至于可以作为常亮，不需担心。<strong>那Point Light的衰减是什么样的？</strong></p><p>球形衰减：<em>想象一下，从一个点向四面八方发射一束光子，随着时间推移，这些光子会以相同的移动速度逐渐远离这个点，就像组成了一个球体表面，而这个点就是球体中心。球的半径随着光子移动增长，光子的密度随着移动就会逐渐降低。这就决定了可见光的亮度。</em> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131192014381-1105326688.png" des="球形衰减" width="250" %}</p><p>衰减公式：球的表面积计算公式 <span class=arithmatex>\(<span class=arithmatex>\(s= 4πr^2\)</span>\)</span>。我们可以通过除以该公式得到光子的密度。把4π作为影响光的强度因子，先忽略掉这个常数。这就得到了衰减因子为<span class=arithmatex>\(<span class=arithmatex>\(1\over d^2\)</span>\)</span>，其中d是光的距离.</p><p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>UnityLight</span><span class=w> </span><span class=nf>CreateLight</span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>){</span><span class=w></span>
<span class=w>    </span><span class=n>UnityLight</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>//light.dir = _WorldSpaceLightPos0.xyz;</span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>lightVec</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>lightVec</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>attenuation</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=p>/</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>lightVec</span><span class=p>,</span><span class=w> </span><span class=n>lightVec</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>color</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_LightColor0</span><span class=p>.</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>attenuation</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>ndotl</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>DotClamped</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131192015561-1922006119.png" des="过曝" width="250" %} <p>靠近光源时非常明亮，这是因为越靠近球体的中心点，距离就越小，直到趋近于0。修改公式<span class=arithmatex>\(<span class=arithmatex>\(1 \over 1 + d^2\)</span>\)</span>。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>float</span><span class=w> </span><span class=n>attenuation</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=p>/</span><span class=w> </span><span class=p>(</span><span class=m>1</span><span class=w> </span><span class=p>+</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>lightVec</span><span class=p>,</span><span class=w> </span><span class=n>lightVec</span><span class=p>));</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>{% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131192016817-807821241.png" des="正常光强" width="250" %}</p><h3 id=光源范围-light-range>光源范围-Light Range<a title="Permanent link"class=headerlink href=#光源范围-light-range></a></h3><p>现实中，光子持续移动直到击中某个物体停止。光变的非常微弱直到肉眼不可见，这意味着光的范围是可能无限远的。而实际上我们不会浪费时间去渲染不可见光，所以我们必须在某个时候停止渲染。</p><p>Point Light 和 Spot Light都有范围，位于范围内的物体将会使用此光源参与绘制，否则不会参与。它们的默认范围都是10，随着范围缩小，调用额外draw Call的物体会更少，这也会提高帧率。</p><p>把范围缩小到1，当拖动光源时会清楚看见物体何时进出这个范围，物体会突然变亮或不亮，要修复它需要确保衰减和范围是同步的。为了确保物体移出光源范围不会突然出现光线过渡，这就要求衰减系数在最大范围时为0</p><p>Unity把片元从世界空间转换到光源空间来计算点光源的衰减，光源空间是灯光对象本地空间坐标，按比例衰减。在该空间，点光源位于原点，任何超过一个单位的都不在该范围内，所以点到原点的距离的平方定义了衰减系数。Unity更进一步，使用距离的平方采样衰减图。这样做确保了衰减早一点下降到0。没有这步，移动光源进出范围时我们仍将看见物体突然变亮或不亮。这个算法函数在AutoLight.cginc文件中。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200131232517828-1226658100.png" des="AutoLight 引用结构" width="250" %}</p><p>我们可以使用_UNITY_LIGHT_ATTENUATION_指令，注意其中有if预处理块，包含三个参数：第一个参数是attenuation；第二个参数是计算阴影；第三个参数是世界坐标。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>//UNITY_LIGHT_ATTENUATION</span>
<span class=err>#</span><span class=n>ifdef</span><span class=w> </span><span class=n>POINT</span><span class=w></span>
<span class=n>uniform</span><span class=w> </span><span class=n>sampler2D</span><span class=w> </span><span class=n>_LightTexture0</span><span class=p>;</span><span class=w></span>
<span class=n>uniform</span><span class=w> </span><span class=n>unityShadowCoord4x4</span><span class=w> </span><span class=n>unity_WorldToLight</span><span class=p>;</span><span class=w></span>
<span class=cp>#define UNITY_LIGHT_ATTENUATION(destName, input, worldPos) \</span><span class=w></span>
<span class=w>    </span><span class=n>unityShadowCoord3</span><span class=w> </span><span class=n>lightCoord</span><span class=w> </span><span class=p>=</span><span class=w> </span>\<span class=w></span>
<span class=w>        </span><span class=n>mul</span><span class=p>(</span><span class=n>unity_WorldToLight</span><span class=p>,</span><span class=w> </span><span class=n>unityShadowCoord4</span><span class=p>(</span><span class=n>worldPos</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>)).</span><span class=n>xyz</span><span class=p>;</span><span class=w> </span>\<span class=w></span>
<span class=w>    </span><span class=k>fixed</span><span class=w> </span><span class=n>destName</span><span class=w> </span><span class=p>=</span><span class=w> </span>\<span class=w></span>
<span class=w>        </span><span class=p>(</span><span class=n>tex2D</span><span class=p>(</span><span class=n>_LightTexture0</span><span class=p>,</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>lightCoord</span><span class=p>,</span><span class=w> </span><span class=n>lightCoord</span><span class=p>).</span><span class=n>rr</span><span class=p>).</span><span class=w> </span>\<span class=w></span>
<span class=w>        </span><span class=n>UNITY_ATTEN_CHANNEL</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>SHADOW_ATTENUATION</span><span class=p>(</span><span class=n>input</span><span class=p>));</span><span class=w></span>
<span class=cp>#endif</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>unityShadowCoord4在其他地方定义的；点击产生一个单精度值，.rr是重复取值组成float2.然后用来采样衰减纹理，而纹理是1维数据，第二个分量也无关紧要； UNITY_ATTEN_CHANNEL可能是r或a,取决于目标平台。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>UnityLight</span><span class=w> </span><span class=nf>CreateLight</span><span class=w> </span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>UnityLight</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=c1>//  float3 lightVec = _WorldSpaceLightPos0.xyz - i.worldPos;</span>
<span class=w>    </span><span class=c1>//  float attenuation = 1 / (dot(lightVec, lightVec));</span>
<span class=w>    </span><span class=n>UNITY_LIGHT_ATTENUATION</span><span class=p>(</span><span class=n>attenuation</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>color</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_LightColor0</span><span class=p>.</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>attenuation</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>ndotl</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>DotClamped</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>需要在引用AutoLight文件之间宏定义POINT，才能呈现最终正确的画面.</p><h2 id=混合光源-mixing-light>混合光源-Mixing Light<a title="Permanent link"class=headerlink href=#混合光源-mixing-light></a></h2><p>关闭Point Light再次打开两个Directional light，这里又出现了错误的addition pass计算，把minor 方向光作为点光源计算。为了解决它，我们引入Shader variant 变体。</p><h3 id=变体-shader-variants>变体-Shader Variants<a title="Permanent link"class=headerlink href=#变体-shader-variants></a></h3><p>选中Shader文件，在Inspector点击Compileed code查看</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// Total snippets: 2</span>
<span class=c1>// --</span>
<span class=c1>// Snippet #0 platforms ffffffff:</span>

<span class=n>Just</span><span class=w> </span><span class=n>one</span><span class=w> </span><span class=n>shader</span><span class=w> </span><span class=n>variant</span><span class=p>.</span><span class=w></span>

<span class=c1>// --</span>
<span class=c1>// Snippet #1 platforms ffffffff:</span>

<span class=n>Just</span><span class=w> </span><span class=n>one</span><span class=w> </span><span class=n>shader</span><span class=w> </span><span class=n>variant</span><span class=p>.</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>打开文件看到2个snippets代码片段，这是shader的passes。分别是base pass 和 additive pass。我们想要在additive pass中创建既支持directional 光又支持point 光的变体，需要使用Unity提供的multi_compile声明关键字，Unity将自动为每个关键字生成独立的shader。变体数量多少会影响编译效率！</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>Pass</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Tags</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"LightMode"</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>"ForwardAdd"</span><span class=w> </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>Blend</span><span class=w> </span><span class=n>One</span><span class=w> </span><span class=n>One</span><span class=w></span>
<span class=w>    </span><span class=n>ZWrite</span><span class=w> </span><span class=n>Off</span><span class=w></span>

<span class=w>    </span><span class=n>CGPROGRAM</span><span class=w></span>
<span class=w>    </span><span class=cp>#pragma target 3.0</span><span class=w></span>
<span class=w>    </span><span class=cp>#pragma multi_compile DIRECTION POINT</span><span class=w></span>
<span class=w>    </span><span class=cp>#pragma vertex MyVertexProgram</span><span class=w></span>
<span class=w>    </span><span class=cp>#pragma fragment MyFragmentProgram</span><span class=w></span>
<span class=w>    </span><span class=c1>//#define POINT</span>
<span class=w>    </span><span class=err>#</span><span class=n>include</span><span class=w> </span><span class=s>"MyLighting.cginc"</span><span class=w></span>
<span class=w>    </span><span class=n>ENDCG</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>编译后能看见2个关键字：</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// Total snippets: 2</span>
<span class=c1>// --</span>
<span class=c1>// Snippet #0 platforms ffffffff:</span>

<span class=n>Just</span><span class=w> </span><span class=n>one</span><span class=w> </span><span class=n>shader</span><span class=w> </span><span class=n>variant</span><span class=p>.</span><span class=w></span>

<span class=c1>// --</span>
<span class=c1>// Snippet #1 platforms ffffffff:</span>
<span class=n>DIRECTION</span><span class=w> </span><span class=n>POINT</span><span class=w></span>

<span class=m>2</span><span class=w> </span><span class=n>keyword</span><span class=w> </span><span class=n>variants</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>scene</span><span class=p>:</span><span class=w></span>

<span class=n>DIRECTION</span><span class=w></span>
<span class=n>POINT</span><span class=w></span>
</code></pre></div></td></tr></table></div><h3 id=使用关键字-keywords>使用关键字-KeyWords<a title="Permanent link"class=headerlink href=#使用关键字-keywords></a></h3><p>Unity决定使用那个变体，是基于当前光源类型和shader中定义的变体关键字。当渲染方向光它就使用_DIRECTIONAL_变体，当渲染点光源它就使用_POINT_变体。如果都不匹配，它就选着变体关键字列表中第一个变体。</p><p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>UnityLight</span><span class=w> </span><span class=nf>CreateLight</span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>){</span><span class=w></span>
<span class=w>    </span><span class=n>UnityLight</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=err>#</span><span class=n>ifdef</span><span class=w> </span><span class=n>POINT</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>lightVec</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#else</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>lightVec</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=w>    </span><span class=n>UNITY_LIGHT_ATTENUATION</span><span class=p>(</span><span class=n>attenuation</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>color</span><span class=w>         </span><span class=p>=</span><span class=w> </span><span class=n>_LightColor0</span><span class=p>.</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>attenuation</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w>           </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>lightVec</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>ndotl</span><span class=w>         </span><span class=p>=</span><span class=w> </span><span class=n>DotClamped</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>light</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200202235053042-1905178954.png" des="变体-两次渲染" width="250" %} <h2 id=聚光源-spotlights>聚光源-Spotlights<a title="Permanent link"class=headerlink href=#聚光源-spotlights></a></h2><p>上面说了方向光和点光源，Unity还提供了聚光灯。聚光灯与点光源类似，不过它发射的是呈圆锥形光束。同样，为了支持聚光灯，需再加一个变体支持。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#pragma multi_compile DIRECTIONAL POINT </span><span class=w></span>
</code></pre></div></td></tr></table></div><p>查看增加了SPOT光源编译后的变体文件<div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// --</span>
<span class=c1>// Snippet #1 platforms ffffffff:</span>
<span class=n>DIRECTION</span><span class=w> </span><span class=n>POINT</span><span class=w> </span><span class=n>SPOT</span><span class=w></span>

<span class=m>3</span><span class=w> </span><span class=n>keyword</span><span class=w> </span><span class=n>variants</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>scene</span><span class=p>:</span><span class=w></span>

<span class=n>DIRECTION</span><span class=w></span>
<span class=n>POINT</span><span class=w></span>
<span class=n>SPOT</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>聚光灯同样有一个（原点）发射点，朝锥形方向发射光子，所以也需要手动计算光的方向<div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#if defined(POINT) || defined(SPOT)</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>lightVec</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>;</span><span class=w></span>
<span class=cp>#else</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>lightVec</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=p>;</span><span class=w></span>
<span class=cp>#endif</span><span class=w></span>
<span class=c1>//...</span>
</code></pre></div></td></tr></table></div><h3 id=聚光源衰减>聚光源衰减<a title="Permanent link"class=headerlink href=#聚光源衰减></a></h3><p>聚光灯衰减方式开始时与点光源相同，转换到光源空间然后计算衰减因子。然后把原点后面所有点强制衰减为0，将光线限制在聚光灯前面的物体上。然后<strong>把光空间中X和Y坐标作为UV坐标采样纹理，用于遮罩光线，该纹理是一个边缘模糊的圆，就像圆锥体。同时变换到光空间实际上是透视变换并使用了其次坐标</strong>。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span class=w> </span><span class=c1>//UNITY_LIGHT_ATTENUATION</span>
<span class=err>#</span><span class=n>ifdef</span><span class=w> </span><span class=n>SPOT</span><span class=w></span>
<span class=n>sampler2D</span><span class=w> </span><span class=n>_LightTexture0</span><span class=p>;</span><span class=w></span>
<span class=n>unityShadowCoord4x4</span><span class=w> </span><span class=n>unity_WorldToLight</span><span class=p>;</span><span class=w></span>
<span class=n>sampler2D</span><span class=w> </span><span class=n>_LightTextureB0</span><span class=p>;</span><span class=w></span>
<span class=n>inline</span><span class=w> </span><span class=k>fixed</span><span class=w> </span><span class=nf>UnitySpotCookie</span><span class=p>(</span><span class=n>unityShadowCoord4</span><span class=w> </span><span class=n>LightCoord</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nf>tex2D</span><span class=p>(</span><span class=n>_LightTexture0</span><span class=p>,</span><span class=w> </span><span class=n>LightCoord</span><span class=p>.</span><span class=n>xy</span><span class=w> </span><span class=p>/</span><span class=w> </span><span class=n>LightCoord</span><span class=p>.</span><span class=n>w</span><span class=w> </span><span class=p>+</span><span class=w> </span><span class=m>0.5</span><span class=p>).</span><span class=n>w</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
<span class=n>inline</span><span class=w> </span><span class=k>fixed</span><span class=w> </span><span class=nf>UnitySpotAttenuate</span><span class=p>(</span><span class=n>unityShadowCoord3</span><span class=w> </span><span class=n>LightCoord</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nf>tex2D</span><span class=p>(</span><span class=n>_LightTextureB0</span><span class=p>,</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>LightCoord</span><span class=p>,</span><span class=w> </span><span class=n>LightCoord</span><span class=p>).</span><span class=n>xx</span><span class=p>).</span><span class=n>UNITY_ATTEN_CHANNEL</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=err>#</span><span class=n>defineUNITY_LIGHT_ATTENUATION</span><span class=p>(</span><span class=n>destName</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=n>worldPos</span><span class=p>)</span><span class=w> </span><span class=err>\</span>\<span class=w></span>
<span class=w>    </span><span class=n>unityShadowCoord4</span><span class=w> </span><span class=n>lightCoord</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>mul</span><span class=p>(</span><span class=n>unity_WorldToLight</span><span class=p>,</span><span class=w> </span><span class=n>unityShadowCoord4</span><span class=p>(</span><span class=n>worldPos</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>));</span><span class=w> </span><span class=err>\</span>\<span class=w></span>
<span class=w>    </span><span class=k>fixed</span><span class=w> </span><span class=n>shadow</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>UNITY_SHADOW_ATTENUATION</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=n>worldPos</span><span class=p>);</span><span class=w> </span><span class=err>\</span>\<span class=w></span>
<span class=w>    </span><span class=k>fixed</span><span class=w> </span><span class=n>destName</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>(</span><span class=n>lightCoord</span><span class=p>.</span><span class=n>z</span><span class=w> </span><span class=p>></span><span class=w> </span><span class=m>0</span><span class=p>)</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>UnitySpotCookie</span><span class=p>(</span><span class=n>lightCoord</span><span class=p>)</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>UnitySpotAttenuate</span><span class=p>(</span><span class=n>lightCoord</span><span class=p>.</span><span class=n>xyz</span><span class=p>)</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>shadow</span><span class=p>;</span><span class=w></span>
<span class=cp>#endif</span><span class=w></span>
</code></pre></div></td></tr></table></div><h2 id=光斑阴影-light-cookies>光斑阴影-Light Cookies<a title="Permanent link"class=headerlink href=#光斑阴影-light-cookies></a></h2><p>Cookies名字来源于剪影<code>[cucoloris]</code>，是指在电影、戏剧、摄影中为光线添加阴影。Unity支持3种light Cookies：DirectionLight、spotLight、pointLight。Cookie需要采样到纹理中。</p><h3 id=聚光灯光斑阴影-spotlight-cookie>聚光灯光斑阴影-Spotlight cookie<a title="Permanent link"class=headerlink href=#聚光灯光斑阴影-spotlight-cookie></a></h3><p><strong>默认的聚光灯遮罩纹理是一个模糊的圆，但它也可以是任意的正方形纹理且它的边缘alpha降到0即可。</strong> 使用cookies的alpha通道遮罩光线，其他rgb通道无关紧要。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200202235053939-538180164.png" url2="posts/2018/month1/catRender5/1692664-20200202235054926-237124774.png" des="spot-light cookies设置" width="250" %}</p><h3 id=方向光斑阴影-directon-light-cookie>方向光斑阴影-Directon light Cookie<a title="Permanent link"class=headerlink href=#方向光斑阴影-directon-light-cookie></a></h3><p>direction lights的cookie是无限平铺，因此边缘必须无缝衔接，边缘不必过渡到0. {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200202235055988-1636252656.png" des="direction cookie" width="250" %}</p><p>cookie size大小决定了可视面积，反过来又影响平铺速度。默认为10。</p><p>带有cookie的Direction light必须转换到光照空间，它也有自己的_UNITY_LIGHT_ATTENUTION_指令。Unity把它作为不同的方向光对待，放置到addive pass渲染，使用_DIRECTIONAL_COOKIE_启用。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#pragma multi_compile DIRECTIONAL DIRECTIONAL_COOKIE POINT SPOT</span><span class=w></span>
</code></pre></div></td></tr></table></div><h3 id=电光源光斑阴影-point-light-cookie>电光源光斑阴影-Point Light cookie<a title="Permanent link"class=headerlink href=#电光源光斑阴影-point-light-cookie></a></h3><p><strong>点光源的cookie是一个围绕球性的cube map映射纹理，同时必须指定_Mapping_映射模式</strong>，使Unity知道如何解释图像，<strong>最好的方法是自己提供一张cube map</strong>，这里先指定自动映射模式。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200202235056907-1628766231.png" des="Mapping模式" width="250" %}</p><p>必须增加POINT_COOKIE关键字编译，Unity提供了一个简短的的关键字语义。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#pragma multi_compile_fwdadd</span><span class=w></span>
<span class=c1>//#pragma multi_compile DIRECTIONAL DIRECTIONAL_COOKIE POINT SPOT</span>
</code></pre></div></td></tr></table></div><p>打开编译后的文件</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// Snippet #1 platforms ffffffff:</span>
<span class=n>DIRECTIONAL</span><span class=w> </span><span class=n>DIRECTIONAL_COOKIE</span><span class=w> </span><span class=n>POINT</span><span class=w> </span><span class=n>POINT_COOKIE</span><span class=w> </span><span class=n>SPOT</span><span class=w></span>

<span class=m>5</span><span class=w> </span><span class=n>keyword</span><span class=w> </span><span class=n>variants</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>scene</span><span class=p>:</span><span class=w></span>

<span class=n>POINT</span><span class=w></span>
<span class=n>DIRECTIONAL</span><span class=w></span>
<span class=n>SPOT</span><span class=w></span>
<span class=n>POINT_COOKIE</span><span class=w></span>
<span class=n>DIRECTIONAL_COOKIE</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>同时带有cookie的点光源方向也需要自己计算</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#if defined(POINT) || defined(POINT_COOKIE) || defined(SPOT)</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
<span class=cp>#else</span><span class=w></span>
<span class=w>    </span><span class=n>light</span><span class=p>.</span><span class=n>dir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>_WorldSpaceLightPos0</span><span class=p>.</span><span class=n>xyz</span><span class=p>;</span><span class=w></span>
<span class=cp>#endif</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>{% include vedio-mini.html _url="<a href=https://thumbs.gfycat.com/HopefulAffectionateChimneyswift-mobile.mp4>https://thumbs.gfycat.com/HopefulAffectionateChimneyswift-mobile.mp4</a>" _type="video/mp4" des="同时渲染三个光" width="250" %}</p><h2 id=顶点光照计算-vertex-lights>顶点光照计算-Vertex Lights<a title="Permanent link"class=headerlink href=#顶点光照计算-vertex-lights></a></h2><p><strong>在Forward前向渲染路径，每个可见的物体都必须在BasePass中渲染一次。这个Pass只关心主方向光，而有cookie的方向光会忽略</strong>。在此之上其他多余的光会自动增加additive pass。因此有多少光就会产生多少Draw Call。</p><p><em>举例，场景中增加四个点光源，让所有物体处于光源范围内。1个base加上4个additive pass，一共25个draw call。即使再增加一个方向光，也不会增加draw call。</em></p><p>在Unity/Edit/Quality中可以设置 <em>Pixel Light Count</em>，定义最大逐像素光照数量，这个决定了有多少个光会在片元函数被作为逐像素光照计算。默认为4个。每个物体渲染的灯光是不同的，Unity根据光的强度和距离从高到低排序，贡献最少的光首先被丢弃不参与计算。</p><p>由于不同的光影响不同的物体，有可能出现矛盾的光照效果。当物体移动时可能变得更糟，移动会导致光线突然变化。这个问题很麻烦，因为光完全关闭了，幸运的是我们可以使用逐顶点渲染这一更节省性能的方式。这意味着光照计算都在顶点函数进行，然后得到的插值结果并传递给片元函数。可以使用定义_VERTEXLIGHT_ON_关键字激活计算。</p><blockquote><p><strong>Unity自带顶点光只支持Point Light</strong>。</p><p>这和逐顶点光照有区别(完全可以在顶点函数计算法线、光线方向、视野方向、反射反向，再用着色模型计算 颜色传递给片元函数，优点性能好，缺点着色粗糙) {: .prompt-tip} {% include vedio-mini.html _url="<a href=https://thumbs.gfycat.com/FlatHeartyElephantbeetle-mobile.mp4>https://thumbs.gfycat.com/FlatHeartyElephantbeetle-mobile.mp4</a>" _type="video/mp4" des="物体受光数量差异" width="250" %}</p></blockquote><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>Pass</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Tags</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>"LightMode"</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>"ForwardBase"</span><span class=w> </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>CGPROGRAM</span><span class=w></span>

<span class=w>    </span><span class=cp>#pragma target 3.0</span><span class=w></span>
<span class=w>    </span><span class=cp>#pragma vertex MyVertexProgram</span><span class=w></span>
<span class=w>    </span><span class=cp>#pragma fragment MyFragmentProgram</span><span class=w></span>

<span class=w>    </span><span class=cp>#pragma multi_compile _ VERTEXLIGHT_ON</span><span class=w></span>
<span class=w>    </span><span class=err>#</span><span class=n>include</span><span class=w> </span><span class=s>"MyLighting.cginc"</span><span class=w></span>

<span class=w>    </span><span class=n>ENDCG</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><h3 id=一个顶点光-one-vertex-light>一个顶点光-One Vertex Light<a title="Permanent link"class=headerlink href=#一个顶点光-one-vertex-light></a></h3><p>把顶点光传到片元函数，需要在<strong>Interpolators</strong>结构体使用VERTEXLIGHT_ON关键字。然后定义一个生成顶点颜色的函数以解耦，由于是从Interpolators读写成员变量，需要inout修饰符。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>struct</span><span class=w> </span><span class=nc>Interpolators</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>position</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>SV_POSITION</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>float2</span><span class=w> </span><span class=n>uv</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>TEXCOORD0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>normal</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>TEXCOORD1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>worldPos</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>TEXCOORD2</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>vertexLightColor</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>TEXCOORD3</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=p>};</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>创建一个单独的函数来计算这种颜色，使用了inout修饰符，同时读取和写入插值器。<div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>void</span><span class=w> </span><span class=nf>ComputeVertexLightColor</span><span class=w> </span><span class=p>(</span><span class=n>inout</span><span class=w> </span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>Interpolators</span><span class=w> </span><span class=nf>MyVertexProgram</span><span class=w> </span><span class=p>(</span><span class=n>VertexData</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>position</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>mul</span><span class=p>(</span><span class=n>UNITY_MATRIX_MVP</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>position</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>mul</span><span class=p>(</span><span class=n>unity_ObjectToWorld</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>position</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>UnityObjectToWorldNormal</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>normal</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>uv</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>TRANSFORM_TEX</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>uv</span><span class=p>,</span><span class=w> </span><span class=n>_MainTex</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>ComputeVertexLightColor</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>UnityShaderVariables定义了一个顶点光颜色数组：<code>unity_LightColor[0].rgb</code></p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>void</span><span class=w> </span><span class=nf>ComputeVertexLightColor</span><span class=w> </span><span class=p>(</span><span class=n>inout</span><span class=w> </span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>        </span><span class=n>i</span><span class=p>.</span><span class=n>vertexLightColor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>rgb</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>然后，在片元函数把顶点光照色增加到所有其他光照色。这可以把顶点光照色作为间接光对待。再把生成间接光的代码剥离解耦，把顶点光照色传递给间接光的漫反射。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>UnityIndirect</span><span class=w> </span><span class=nf>CreateIndirectLight</span><span class=w> </span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>UnityIndirect</span><span class=w> </span><span class=n>indirectLight</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>specular</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>        </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>vertexLightColor</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>indirectLight</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>float4</span><span class=w> </span><span class=nf>MyFragmentProgram</span><span class=w> </span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>SV_TARGET</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>viewDir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>_WorldSpaceCameraPos</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>albedo</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>tex2D</span><span class=p>(</span><span class=n>_MainTex</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>uv</span><span class=p>).</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>_Tint</span><span class=p>.</span><span class=n>rgb</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>specularTint</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>oneMinusReflectivity</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>albedo</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>DiffuseAndSpecularFromMetallic</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>albedo</span><span class=p>,</span><span class=w> </span><span class=n>_Metallic</span><span class=p>,</span><span class=w> </span><span class=n>specularTint</span><span class=p>,</span><span class=w> </span><span class=n>oneMinusReflectivity</span><span class=w></span>
<span class=w>    </span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>//  UnityIndirect indirectLight;</span>
<span class=w>    </span><span class=c1>//  indirectLight.diffuse = 0;</span>
<span class=w>    </span><span class=c1>//  indirectLight.specular = 0;</span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nf>UNITY_BRDF_PBS</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>albedo</span><span class=p>,</span><span class=w> </span><span class=n>specularTint</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>oneMinusReflectivity</span><span class=p>,</span><span class=w> </span><span class=n>_Smoothness</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>viewDir</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>CreateLight</span><span class=p>(</span><span class=n>i</span><span class=p>),</span><span class=w> </span><span class=n>CreateIndirectLight</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>当把 <em>Pixel Light Count</em> 数量调为0时，每个物体被渲染为对应光照色的剪影。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200205112809047-1570775625.png" des="纯色轮廓，0 Pixel Light Count" width="250" %}</p><p>Unity支持多达四个顶点光，这些光的坐标存储在float4变量： - unity_4LightPosX0 - unity_4LightPosY0 - unity_4LightPosZ0</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>void</span><span class=w> </span><span class=nf>ComputeVertexLightColor</span><span class=w> </span><span class=p>(</span><span class=n>inout</span><span class=w> </span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>lightPos</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>float3</span><span class=p>(</span><span class=w></span>
<span class=w>            </span><span class=n>unity_4LightPosX0</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>unity_4LightPosY0</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>unity_4LightPosZ0</span><span class=p>.</span><span class=n>x</span><span class=w></span>
<span class=w>        </span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>i</span><span class=p>.</span><span class=n>vertexLightColor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>rgb</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>这几个变量定义在 <em>UnityShaderVariables.cginc</em> 文件，这些变量的x y z w表示依次表示每个光的(x,y,z)。 接下来计算光的方向、反射方向、衰减<span class=arithmatex>\(<span class=arithmatex>\(1\over 1+d^2\)</span>\)</span>，得到最终的颜色。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>void</span><span class=w> </span><span class=nf>ComputeVertexLightColor</span><span class=w> </span><span class=p>(</span><span class=n>inout</span><span class=w> </span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>lightPos</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>float3</span><span class=p>(</span><span class=w></span>
<span class=w>            </span><span class=n>unity_4LightPosX0</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>unity_4LightPosY0</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>unity_4LightPosZ0</span><span class=p>.</span><span class=n>x</span><span class=w></span>
<span class=w>        </span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>lightVec</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>lightPos</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>float3</span><span class=w> </span><span class=n>lightDir</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normalize</span><span class=p>(</span><span class=n>lightVec</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>ndotl</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>DotClamped</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>lightDir</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>attenuation</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=p>/</span><span class=w> </span><span class=p>(</span><span class=m>1</span><span class=w> </span><span class=p>+</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>lightVec</span><span class=p>,</span><span class=w> </span><span class=n>lightVec</span><span class=p>));</span><span class=w></span>
<span class=w>        </span><span class=n>i</span><span class=p>.</span><span class=n>vertexLightColor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>ndotl</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>attenuation</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>用这计算大三角形插值的镜面反射会很糟，所幸Unity提供了衰减因子<code>unity_4LightAtten0</code>，可帮助近似计算像素光的衰减，<span class=arithmatex>\(<span class=arithmatex>\(1\over 1+d^2a\)</span>\)</span> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200205112810171-1985060187.png" des="一个像素光呈现的轮廓色" width="250" %}</p><h3 id=四个顶点光-four-vertex-light>四个顶点光-Four Vertex Light<a title="Permanent link"class=headerlink href=#四个顶点光-four-vertex-light></a></h3><p>为了支持4个顶点光，就需要手写四次类似的代码，然后把结果加在一起。Unity提供了<code>Shade4PointLights函数</code>，参数需要：3个光的位置，4个顶点光的颜色，4个顶点光的衰减色，顶点世界坐标，顶点法线。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>void</span><span class=w> </span><span class=nf>CreateVertexLightColor</span><span class=p>(</span><span class=n>inout</span><span class=w> </span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>){</span><span class=w></span>
<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>    </span><span class=n>i</span><span class=p>.</span><span class=n>vertexLightCoolr</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>Shade4PointLights</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>unity_4LightPosX0</span><span class=p>,</span><span class=w> </span><span class=n>unity_4LightPosY0</span><span class=p>,</span><span class=w> </span><span class=n>unity_4LightPosZ0</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>rgb</span><span class=p>,</span><span class=w> </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>1</span><span class=p>].</span><span class=n>rgb</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>4</span><span class=p>].</span><span class=n>rgb</span><span class=p>,</span><span class=w> </span><span class=n>unity_LightColor</span><span class=p>[</span><span class=m>3</span><span class=p>].</span><span class=n>rgb</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>unity_4LightAtten0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>worldPos</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=w></span>
<span class=w>    </span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p><code>Shade4PointLights</code>源码。不同的是计算光的方向 和 方向的摸，rsqrt平方根的倒数</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// Used in ForwardBase pass: Calculates diffuse lighting from 4 point lights, with data packed in a special way.</span>
<span class=n>float3</span><span class=w> </span><span class=nf>Shade4PointLights</span><span class=w> </span><span class=p>(</span><span class=w></span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>lightPosX</span><span class=p>,</span><span class=w> </span><span class=n>float4</span><span class=w> </span><span class=n>lightPosY</span><span class=p>,</span><span class=w> </span><span class=n>float4</span><span class=w> </span><span class=n>lightPosZ</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>lightColor0</span><span class=p>,</span><span class=w> </span><span class=n>float3</span><span class=w> </span><span class=n>lightColor1</span><span class=p>,</span><span class=w> </span><span class=n>float3</span><span class=w> </span><span class=n>lightColor2</span><span class=p>,</span><span class=w> </span><span class=n>float3</span><span class=w> </span><span class=n>lightColor3</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>lightAttenSq</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>pos</span><span class=p>,</span><span class=w> </span><span class=n>float3</span><span class=w> </span><span class=n>normal</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// to light vectors</span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>toLightX</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>lightPosX</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>pos</span><span class=p>.</span><span class=n>x</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>toLightY</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>lightPosY</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>pos</span><span class=p>.</span><span class=n>y</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>toLightZ</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>lightPosZ</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>pos</span><span class=p>.</span><span class=n>z</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// squared lengths</span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>lengthSq</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>lengthSq</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>toLightX</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>toLightX</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>lengthSq</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>toLightY</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>toLightY</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>lengthSq</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>toLightZ</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>toLightZ</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// don't produce NaNs if some vertex position overlaps with the light</span>
<span class=w>    </span><span class=n>lengthSq</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>max</span><span class=p>(</span><span class=n>lengthSq</span><span class=p>,</span><span class=w> </span><span class=m>0.000001</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// NdotL</span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>ndotl</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>ndotl</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>toLightX</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>x</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>ndotl</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>toLightY</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>y</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>ndotl</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>toLightZ</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>z</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// correct NdotL</span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>corr</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>rsqrt</span><span class=p>(</span><span class=n>lengthSq</span><span class=p>);</span><span class=c1>//平方根倒数</span>
<span class=w>    </span><span class=n>ndotl</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>max</span><span class=w> </span><span class=p>(</span><span class=n>float4</span><span class=p>(</span><span class=m>0</span><span class=p>,</span><span class=m>0</span><span class=p>,</span><span class=m>0</span><span class=p>,</span><span class=m>0</span><span class=p>),</span><span class=w> </span><span class=n>ndotl</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>corr</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=c1>// attenuation</span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>atten</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>1.0</span><span class=w> </span><span class=p>/</span><span class=w> </span><span class=p>(</span><span class=m>1.0</span><span class=w> </span><span class=p>+</span><span class=w> </span><span class=n>lengthSq</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>lightAttenSq</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>float4</span><span class=w> </span><span class=n>diff</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>ndotl</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>atten</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// final color</span>
<span class=w>    </span><span class=n>float3</span><span class=w> </span><span class=n>col</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>col</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>lightColor0</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>diff</span><span class=p>.</span><span class=n>x</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>col</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>lightColor1</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>diff</span><span class=p>.</span><span class=n>y</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>col</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>lightColor2</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>diff</span><span class=p>.</span><span class=n>z</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>col</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>lightColor3</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>diff</span><span class=p>.</span><span class=n>w</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>col</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>{% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200205112811154-1493734512.png" des="4个顶点光" width="250" %}</p><p><strong>像素光与顶点光</strong>：在Light组件RenderMode有两个重要选项，Important将指示该light被渲染为像素光，not Important指示该light被渲染为顶点光。下图是2个顶点和2个像素光对比。<strong>不管物体有没有处于四个顶点光范围内，其计算量不变。</strong> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200205112812177-997863942.png" des="两个顶点两个像素。<strong>注意右下角差别</strong>" width="250" %} {% include vedio-mini.html _url="<a href=https://thumbs.gfycat.com/GrandioseNeedyGeese-mobile.mp4>https://thumbs.gfycat.com/GrandioseNeedyGeese-mobile.mp4</a>" _type="video/mp4" des="顶点和像素光对比" width="250" %}</p><h2 id=球谐函数-spherical-harmonics>球谐函数-Spherical Harmonics<a title="Permanent link"class=headerlink href=#球谐函数-spherical-harmonics></a></h2><p>除了用像素光和顶点光以外，还可以用球谐函数计算支持所有光源类型。<strong>球谐函数思想是用一个函数描述入射光在球体表面某一点的情况</strong>。通常该函数用球坐标描述，但也可以用3D坐标。这允许使用物体的法向量来采样该函数。要创建该函数，需要采样所有方向上的光照强度，然后想办法转为一个连续函数。理想情况是在物体表面每个点都采样，但这是不现实的，这需要<strong>噪声理论算法</strong>近似模拟来完成。</p><ul><li>首先，只能从物体本地原点角度定义该函数，这对沿物体表面变化不大的光照条件来说很好。尤其是对于小物体来说，光照要么弱要么距离远。这也意味着，这种计算方式与像素光或顶点光的情况不同。</li><li>其次，我们还需要近似模拟函数本身。这就要把任何连续函数拆解为多个不同频率的连续函数，这可能有无限多个频率函数来组合。</li></ul><p>从基本正弦函数开始 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124114808-974151051.png" des="Sine wave, <span class=arithmatex>\(<span class=arithmatex>\(Sin 2πx\)</span>\)</span>" width="250" %}</p><p>增大一倍震动频率，降低振幅 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124115532-334410632.png" des="双频率半振幅，<span class=arithmatex>\(<span class=arithmatex>\(Sin 4πx\over 2\)</span>\)</span>" width="250" %}</p><p>把以上两种频率振幅函数加在一起 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124116354-1539383463.png" des="<span class=arithmatex>\(<span class=arithmatex>\(Sin 2πx + {Sin 4πx\over 2}\)</span>\)</span>" width="250" %} 基于上面，我们可以无限加大频率降低振幅 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124117213-1122516421.png" des="3倍 和 4倍" width="250" %}</p><p>把各频率加在一起，又可组成新的更复杂的函数 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124117996-199402232.png" des="4倍振幅<span class=arithmatex>\(<span class=arithmatex>\(\sum{_{i=1} ^4} {Sin2\pi ix \over i^2}\)</span>\)</span>" width="250" %}</p><p><em>本示例使用具有固定模式的规则正弦波函数。为了用正弦波函数描述任意函数，必须调整每个频段的频率，振幅和偏移，直到获得完美的结果匹配为止。使用的频带越少，近似值的准确性就越低。 该技术用于压缩其他很多东西，例如声音和图像数据。在我们的案例中，我们将使用它来近似计算3D照明。</em></p><p>该函数的最大特征体现在最低频率处，为此需要丢弃最高频率处，这也意味着会丢失一些光照的细节变化。但是当光线变化不快时问题不大，所以我们需要再次限制漫反射光照。</p><h3 id=球谐函数频率-spherical-harmonics-bands>球谐函数频率-Spherical Harmonics Bands<a title="Permanent link"class=headerlink href=#球谐函数频率-spherical-harmonics-bands></a></h3><p>最简单的方式，假设各个方向的照明都是一样的，照明颜色近似为均匀色。</p><ul><li>第一个波段标识为<span class=arithmatex>\(<span class=arithmatex>\(Y_0^0\)</span>\)</span>，它由单个子函数定义，该子函数只是一个常数值。</li><li>第二个波段引入线性方向光，所有光线方向一致。有三个函数分别用<span class=arithmatex>\(<span class=arithmatex>\(Y_1^{-1}\)</span>\)</span>、<span class=arithmatex>\(<span class=arithmatex>\(Y_1^0\)</span>\)</span>、<span class=arithmatex>\(<span class=arithmatex>\(Y_1^1\)</span>\)</span>标识。 每个函数都包含一个法线坐标，乘以一个常数。</li><li>第三个波段更加复杂。由五个函数，<span class=arithmatex>\(<span class=arithmatex>\(Y_2^{−2}\)</span>\)</span>、<span class=arithmatex>\(<span class=arithmatex>\(Y_2^{-1}\)</span>\)</span>、<span class=arithmatex>\(<span class=arithmatex>\(Y_2^0\)</span>\)</span>、<span class=arithmatex>\(<span class=arithmatex>\(Y_2^1\)</span>\)</span>、<span class=arithmatex>\(<span class=arithmatex>\(Y_2^2\)</span>\)</span>。这些函数是二次函数，这意味着它们包含两个法线坐标的乘积。</li></ul><p>先Unity只使用了三个波段描述球谐函数，定义在一张表内：</p><table><thead><tr><th align=center></th><th align=center>-2</th><th align=center>-1</th><th align=center>0</th><th align=center>1</th><th align=center>2</th></tr></thead><tbody><tr><td align=center>0</td><td align=center></td><td align=center></td><td align=center>1</td><td align=center></td><td align=center></td></tr><tr><td align=center>1</td><td align=center></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\(-y\sqrt3\)</span>\)</span></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\(z\sqrt3\)</span>\)</span></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\(−x\sqrt3\)</span>\)</span></td><td align=center></td></tr><tr><td align=center>2</td><td align=center><span class=arithmatex>\(<span class=arithmatex>\(xy\sqrt{15}\)</span>\)</span></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\(−yz\sqrt{15}\)</span>\)</span></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\((3z^2−1){\sqrt{5}\over2}\)</span>\)</span></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\(−xz\sqrt{15}\)</span>\)</span></td><td align=center><span class=arithmatex>\(<span class=arithmatex>\((x^2−y^2){\sqrt{15}\over 2}\)</span>\)</span></td></tr></tbody></table><blockquote><p>什么决定了这个函数的形状？</p><p>表的索引用Y表示，<span class=arithmatex>\(<span class=arithmatex>\(Y_i^j(i∈(0,2), j∈(-2,2))\)</span>\)</span>. Sine代表Y轴。</p><p><span class=arithmatex>\(<span class=arithmatex>\(Y_i^j\)</span>\)</span>从何而来?</p><p>球面谐波是拉普拉斯方程在球面上的一个解。数学是相当复杂的。函数的定义是<span class=arithmatex>\(<span class=arithmatex>\(Y_m^l=K_l^me^{imφ}P_l^{| m|}cosθ,l∈N, –l ≤ m ≤ l\)</span>\)</span> 而P_l^m项是勒让德多项式和Klm项是标准化常数。<br> 这是复杂形式的定义，使用复数i和球坐标，φ和θ。你也可以使用它的一个真实的版本，用三维坐标计 算这就引出了我们使用的函数。 {: .prompt-tip}</p></blockquote><p>最终的结果是把所有九项计算后加在一起，简化后<span class=arithmatex>\(<span class=arithmatex>\(a + by + cz + dx + exy + fyz + gz^2 + hxz + i(x^2−y^2)\)</span>\)</span>，其中a到i是常数因子。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=kt>float</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>.</span><span class=n>x</span><span class=p>;</span><span class=w></span>
<span class=k>return</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>></span><span class=w> </span><span class=m>0</span><span class=w> </span><span class=p>?</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>float4</span><span class=p>(</span><span class=m>1</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>)</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=p>-</span><span class=n>t</span><span class=p>;</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>{% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124120344-1376165169.png" des="t=1" %} {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124121194-1995098906.png" url2="posts/2018/month1/catRender5/1692664-20200206124122027-1240842546.png" url3="posts/2018/month1/catRender5/1692664-20200206124122834-482072433.png" des="t=x,y,z" %} {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206124123829-182236415.png" url2="posts/2018/month1/catRender5/1692664-20200206124124766-1281263316.png" url3="posts/2018/month1/catRender5/1692664-20200206124125680-1702435885.png" url4="posts/2018/month1/catRender5/1692664-20200206124126718-1286575002.png" url5="posts/2018/month1/catRender5/1692664-20200206124127715-986748162.png" url6="posts/2018/month1/catRender5/1692664-20200206124128687-1199639191.png" des="t=xy,yz,zz,xz,xx-yy" %}</p><h3 id=实际运用球谐函数-using-spherical-harmonics>实际运用球谐函数-Using Spherical Harmonics<a title="Permanent link"class=headerlink href=#实际运用球谐函数-using-spherical-harmonics></a></h3><p>Unity提供了现成的27数字可供使用，定义在_UnityShadervariables.cginc_文件中的7个half4变量。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// SH lighting environment</span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHAr</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHAg</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHAb</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHBr</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHBg</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHBb</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>unity_SHC</span><span class=p>;</span><span class=n>View</span><span class=w> </span><span class=n>Code</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>同时_UnityCG.cginc_也提供了ShadeSH9球谐函数。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// ShadeSH9源码实现</span>
<span class=c1>// normal should be normalized, w=1.0</span>
<span class=n>half3</span><span class=w> </span><span class=nf>SHEvalLinearL0L1</span><span class=w> </span><span class=p>(</span><span class=n>half4</span><span class=w> </span><span class=n>normal</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>half3</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// Linear (L1) + constant (L0) polynomial terms</span>
<span class=w>    </span><span class=n>x</span><span class=p>.</span><span class=n>r</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>unity_SHAr</span><span class=p>,</span><span class=n>normal</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>x</span><span class=p>.</span><span class=n>g</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>unity_SHAg</span><span class=p>,</span><span class=n>normal</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>x</span><span class=p>.</span><span class=n>b</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>unity_SHAb</span><span class=p>,</span><span class=n>normal</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// normal should be normalized, w=1.0</span>
<span class=n>half3</span><span class=w> </span><span class=nf>SHEvalLinearL2</span><span class=w> </span><span class=p>(</span><span class=n>half4</span><span class=w> </span><span class=n>normal</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>half3</span><span class=w> </span><span class=n>x1</span><span class=p>,</span><span class=w> </span><span class=n>x2</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// 4 of the quadratic (L2) polynomials</span>
<span class=w>    </span><span class=n>half4</span><span class=w> </span><span class=n>vB</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>xyzz</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>yzzx</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>x1</span><span class=p>.</span><span class=n>r</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>unity_SHBr</span><span class=p>,</span><span class=n>vB</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>x1</span><span class=p>.</span><span class=n>g</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>unity_SHBg</span><span class=p>,</span><span class=n>vB</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>x1</span><span class=p>.</span><span class=n>b</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>dot</span><span class=p>(</span><span class=n>unity_SHBb</span><span class=p>,</span><span class=n>vB</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// Final (5th) quadratic (L2) polynomial</span>
<span class=w>    </span><span class=n>half</span><span class=w> </span><span class=n>vC</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>x</span><span class=p>*</span><span class=n>normal</span><span class=p>.</span><span class=n>x</span><span class=w> </span><span class=p>-</span><span class=w> </span><span class=n>normal</span><span class=p>.</span><span class=n>y</span><span class=p>*</span><span class=n>normal</span><span class=p>.</span><span class=n>y</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>x2</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>unity_SHC</span><span class=p>.</span><span class=n>rgb</span><span class=w> </span><span class=p>*</span><span class=w> </span><span class=n>vC</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x1</span><span class=w> </span><span class=p>+</span><span class=w> </span><span class=n>x2</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// normal should be normalized, w=1.0</span>
<span class=c1>// output in active color space</span>
<span class=n>half3</span><span class=w> </span><span class=nf>ShadeSH9</span><span class=w> </span><span class=p>(</span><span class=n>half4</span><span class=w> </span><span class=n>normal</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// Linear + constant polynomial terms</span>
<span class=w>    </span><span class=n>half3</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>SHEvalLinearL0L1</span><span class=w> </span><span class=p>(</span><span class=n>normal</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// Quadratic polynomials</span>
<span class=w>    </span><span class=n>res</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>SHEvalLinearL2</span><span class=w> </span><span class=p>(</span><span class=n>normal</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=err>#</span><span class=n>ifdef</span><span class=w> </span><span class=n>UNITY_COLORSPACE_GAMMA</span><span class=w></span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>LinearToGammaSpace</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>在片元函数直接返回球谐光照，并关闭所有light组件。</p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>float3</span><span class=w> </span><span class=n>shColor</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>ShadeSH9</span><span class=p>(</span><span class=n>float4</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>));</span><span class=w></span>
<span class=k>return</span><span class=w> </span><span class=nf>float4</span><span class=p>(</span><span class=n>shColor</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>);</span><span class=w></span>
</code></pre></div></td></tr></table></div><p>物体不再是纯黑色了，选取了环境光颜色 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206155314631-865251110.png" des="关闭环境光的球谐着色" %}</p><p>当场景里有大于light pixel count数量的光，多余的光会被计算为球谐光。如果不够，就会只采样环境光着色 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206155315529-220132043.png" des="多余的光用球谐着色" %}</p><p>像计算顶点光一样，把球谐光照数据加到漫反射间接光之上，同时确保不要提供负数值。</p><p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>UnityIndirect</span><span class=w> </span><span class=nf>CreateIndirectLight</span><span class=w> </span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>UnityIndirect</span><span class=w> </span><span class=n>indirectLight</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>specular</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=m>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=cp>#if defined(VERTEXLIGHT_ON)</span><span class=w></span>
<span class=w>        </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>vertexLightColor</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=cp>#endif</span><span class=w></span>

<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>max</span><span class=p>(</span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=n>ShadeSH9</span><span class=p>(</span><span class=n>float4</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>)));</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>indirectLight</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>float4</span><span class=w> </span><span class=nf>MyFragmentProgram</span><span class=w> </span><span class=p>(</span><span class=n>Interpolators</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>SV_TARGET</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=c1>//  float3 shColor = ShadeSH9(float4(i.normal, 1));</span>
<span class=c1>//  return float4(shColor, 1);</span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nf>UNITY_BRDF_PBS</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>albedo</span><span class=p>,</span><span class=w> </span><span class=n>specularTint</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>oneMinusReflectivity</span><span class=p>,</span><span class=w> </span><span class=n>_Smoothness</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=n>viewDir</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>CreateLight</span><span class=p>(</span><span class=n>i</span><span class=p>),</span><span class=w> </span><span class=n>CreateIndirectLight</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></td></tr></table></div> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206155316590-1216297444.png" des="2个important 6个not important" %} <p>由于球谐光是不重要的光，我们也像计算顶点光一样在base pass通道计算，但是不能跟顶点光使用同一个关键字，需要独立定义FORWARD_BASE_PASS关键字。</p><p><div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#if defined(FORWARD_BASE_PASS)</span><span class=w></span>
<span class=w>    </span><span class=n>indirectLight</span><span class=p>.</span><span class=n>diffuse</span><span class=w> </span><span class=p>+=</span><span class=w> </span><span class=n>max</span><span class=p>(</span><span class=m>0</span><span class=p>,</span><span class=w> </span><span class=n>ShadeSH9</span><span class=p>(</span><span class=n>float4</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>normal</span><span class=p>,</span><span class=w> </span><span class=m>1</span><span class=p>)));</span><span class=w></span>
<span class=cp>#endif</span><span class=w></span>
</code></pre></div></td></tr></table></div> {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206155317744-1485713575.png" des="三种着色：像素、顶点、球谐" %} <h3 id=球谐采样skybox>球谐采样Skybox<a title="Permanent link"class=headerlink href=#球谐采样skybox></a></h3><p>关闭所有的光，使用默认天空盒。这时开始渲染天空盒，它是基于主方向光程序化生成的天空盒。由于没有激活light，光就像在地平线附近徘徊，同时物体选取了天空盒颜色着色，有那么点微妙变化。这是球谐函数作用的结果。物体突然变得更亮了!因为环境因素的影响非常大。程序skybox代表的是一个完美的晴天。在这种情况下，白色的表面会显得非常明亮。这种效果在伽马空间渲染时是最强的。在现实生活中并没有很多完全白色的表面，它们通常要暗得多。 {% include img-picture.html url1="posts/2018/month1/catRender5/1692664-20200206155319086-415300986.png" des="左有球谐函数，右无" %}</p><hr><blockquote class=page-copyright><span><i class=md-icon><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="m22.7 19-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4Z"/></svg></i>本页面最近更新：</span><span class=facts_modified></span>，<a class=edit_history>更新历史</a><br><span><i class=md-icon><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg></i>发现错误？ <a class=page_edit_url href=https://github.com/damonc-top/damonc-top.github.io/discussions/posts/unity3d/shader/translater/catlikecoding/2018-01-03-Unity_Multi_Light.md title=编辑此页>在 GitHub 评论指正！</a></span><br><span><i class=md-icon><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M16 17v2H2v-2s0-4 7-4 7 4 7 4m-3.5-9.5A3.5 3.5 0 1 0 9 11a3.5 3.5 0 0 0 3.5-3.5m3.44 5.5A5.32 5.32 0 0 1 18 17v2h4v-2s0-3.63-6.06-4M15 4a3.39 3.39 0 0 0-1.93.59 5 5 0 0 1 0 5.82A3.39 3.39 0 0 0 15 11a3.5 3.5 0 0 0 0-7Z"/></svg></i>本文作者：</span><span class=page_contributors>catlikecoding</span><br><span><i class=md-icon><svg viewbox="0 0 24 24"xmlns=http://www.w3.org/2000/svg><path d="M10.08 10.86c.05-.33.16-.62.3-.86.3-.56.81-.85 1.5-.86.45 0 .86.2 1.15.49.28.31.47.74.47 1.17h1.8c-.02-.47-.11-.9-.3-1.3-.15-.38-.38-.72-.68-1-1.45-1.34-4.14-1.15-5.37.37-1.29 1.67-1.32 4.59-.01 6.26 1.21 1.49 3.86 1.7 5.3.37.31-.25.56-.56.76-.92.16-.36.27-.74.28-1.15H13.5c0 .21-.07.4-.16.57-.09.19-.21.34-.34.47-.33.26-.72.4-1.14.4-.36-.01-.66-.08-.89-.23a1.41 1.41 0 0 1-.59-.64c-.5-.9-.42-2.15-.3-3.14M12 2C6.5 2 2 6.5 2 12c.53 13.27 19.5 13.26 20 0 0-5.5-4.5-10-10-10m0 18c-4.41 0-8-3.59-8-8 .44-10.61 15.56-10.61 16 0 0 4.41-3.59 8-8 8Z"/></svg></i>本页面的全部内容在 <strong><a href=https://creativecommons.org/licenses/by-sa/4.0/deed.zh>CC BY-SA 4.0</a> 和 <a href=https://github.com/zTrix/sata-license>SATA</a></strong> 协议之条款下提供，附加条款亦可能应用</span></blockquote><div class=giscus data-no-instant id=__comments></div><div id=__comments_script></div><script>var comments=document.createElement("script"),commentsTheme="slate"===document.body.dataset.mdColorScheme?"dark":"light";Object.entries({async:!0,src:"https://giscus.app/client.js",crossOrigin:"anonymous","data-repo":"damonc-top/damonc-top.github.io","data-repo-id":"R_kgDOHK_iGQ","data-category":"评论","data-category-id":"DIC_kwDOHK_iGc4COonC","data-mapping":"specific","data-term":"Unity 基础光照多光源采样(翻译五)","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":commentsTheme,"data-lang":"zh-CN","data-loading":"lazy"}).forEach(t=>comments.setAttribute(t[0],t[1])),document.getElementById("__comments_script").replaceWith(comments)</script></article></div></div></main><script>function scrollFunction(){20<document.body.scrollTop||20<document.documentElement.scrollTop?document.getElementById("myBtn").style.display="block":document.getElementById("myBtn").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}window.onscroll=function(){scrollFunction()}</script><button class=data-tip-left data-tip=回到顶部 id=myBtn onclick=topFunction()><svg class="Zi Zi--BackToTop data-tip-left"viewbox="0 0 24 24"data-tip=回到顶部 fill=currentColor height=24 width=24><path d="M16.036 19.59a1 1 0 0 1-.997.995H9.032a.996.996 0 0 1-.997-.996v-7.005H5.03c-1.1 0-1.36-.633-.578-1.416L11.33 4.29a1.003 1.003 0 0 1 1.412 0l6.878 6.88c.782.78.523 1.415-.58 1.415h-3.004v7.005z"></path></svg></button><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright><div class=md-copyright__highlight>Copyright © 2016 - 2024 银河揽月</div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs <div id=miitbeian></div> </a></div><div class=build_date_utc style=float:right><a href=https://github.com/damonc-top/damonc-top.github.io> 最近更新：6c2a14f, 2024-09-24 </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"base": "../../../../../..", "features": ["navigation.tabs", "navigation.instant"], "search": "../../../../../../assets/javascripts/workers/search.8e7a41fd.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script><script src=../../../../../../assets/javascripts/bundle.c15c428f.min.js></script><script src=../../../../../../extension/js/math-csr.js?math-csr></script><script src=../../../../../../assets/vendor/mathjax/es5/tex-mml-chtml.js?math-csr></script><script>"use strict";"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js",{scope:"/"}).then(function(e){console.log("PWA Registration succeeded. Scope is "+e.scope)}).catch(function(e){console.log("PWA Registration failed with "+e)})</script></body></html>